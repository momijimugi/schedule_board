<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>‰ΩúÊõ≤„Çπ„Ç±„Ç∏„É•„Éº„É´„Éú„Éº„Éâ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="256x256" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <style>
    :root {
      --bg-main: #0b0c10;
      --bg-panel: #151722;
      --bg-panel-soft: #1b1e2b;
      --bg-accent: radial-gradient(circle at top left, #38324f 0%, #151722 45%, #05060a 100%);
      --gold: #f2c56b;
      --gold-soft: #f2d9a6;
      --text-main: #f5f5f7;
      --text-muted: #a3a7c2;
      --border-soft: rgba(255,255,255,0.06);
      --danger: #ff6b81;
      --today: rgba(242,197,107,0.45);
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.55);
      --radius-xl: 18px;
      --radius-lg: 12px;
      --radius-md: 8px;
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.25s ease-out;
      --cell-height: 28px;
      --cell-width: 70px;
      --cell-font-size: 0.68rem;
      --cell-bg: rgba(5,6,11,0.7);
      --sidebar-width: 280px;
    }

    body.theme-dark {
      color-scheme: dark;
    }

    body.theme-light {
      --bg-main: #f5f7fb;
      --bg-panel: #ffffff;
      --bg-panel-soft: #f6f7fb;
      --bg-accent: radial-gradient(circle at top left, #ffffff 0%, #f3f6fb 55%, #e9edf7 100%);
      --text-main: #1f2430;
      --text-muted: #64718b;
      --border-soft: rgba(0,0,0,0.08);
      --danger: #d64562;
      --today: rgba(242,197,107,0.28);
      --shadow-soft: 0 16px 38px rgba(0,0,0,0.12);
      --cell-bg: #ffffff;
      color-scheme: light;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top left, #2c2540 0%, #05060a 55%, #000000 100%);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app-shell {
      display: flex;
      flex-direction: row;
      width: 100%;
      max-width: 100%;
      min-height: 80vh;
      background: var(--bg-accent);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.06);
      overflow: hidden;
      position: relative;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(242,197,107,0.16), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.6;
      pointer-events: none;
    }

    .sidebar {
      position: relative;
      width: var(--sidebar-width);
      padding: 18px 18px 18px 20px;
      background: linear-gradient(160deg, rgba(10,11,18,0.96), rgba(10,11,18,0.9));
      border-right: 1px solid rgba(255,255,255,0.05);
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 1;
    }

    .main {
      flex: 1;
      padding: 16px 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      z-index: 1;
      min-width: 0;
    }

    .app-title {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 12px;
    }

    .app-title-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 220px;
    }

    .app-title-main {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .app-title-main span.logo-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff7e0, #f2c56b 45%, #b57a28 100%);
      box-shadow: 0 0 16px rgba(242,197,107,0.9);
      flex-shrink: 0;
    }

    .app-title-sub {
      font-size: 0.72rem;
      color: var(--text-muted);
      opacity: 0.9;
      line-height: 1.4;
      white-space: normal;
    }

    .pill {
      font-size: 0.72rem;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(242,197,107,0.55);
      color: var(--gold-soft);
      background: linear-gradient(135deg, rgba(242,197,107,0.16), rgba(10,11,18,0.9));
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      margin-top: 4px;
      align-self: flex-start;
    }

    .pill small {
      color: var(--text-muted);
      font-size: 0.68rem;
    }

    .section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .sidebar-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 0.8rem;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 0.9rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(242,197,107,0.9), rgba(210,160,82,1));
      color: #1b1307;
      border-color: rgba(0,0,0,0.4);
      font-weight: 600;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
    }

    .btn-soft {
      background: rgba(255,255,255,0.03);
    }

    .btn-soft:hover {
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }

    .btn-sm {
      padding: 5px 9px;
      font-size: 0.75rem;
    }

    .btn-ghost {
      background: transparent;
      border-color: rgba(255,255,255,0.04);
      color: var(--text-muted);
    }

    .btn-ghost.active {
      border-color: rgba(242,197,107,0.8);
      color: var(--gold-soft);
      background: rgba(242,197,107,0.1);
    }

    .btn-icon-only {
      padding-inline: 6px;
      min-width: 0;
    }

    .project-list {
      background: var(--bg-panel-soft);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 6px 4px;
      max-height: 100%;
      overflow-y: auto;
    }

    .project-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      margin: 2px 0;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
      border: 1px solid transparent;
      font-size: 0.8rem;
    }

    .project-item:hover {
      background: rgba(255,255,255,0.04);
      transform: translateY(-1px);
    }

    .project-item.active {
      background: rgba(242,197,107,0.12);
      border-color: rgba(242,197,107,0.8);
    }

    .project-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .project-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--gold-soft);
      opacity: 0.9;
    }

    .project-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(10,11,18,0.86);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-soft);
      padding: 8px 10px 8px 12px;
      backdrop-filter: blur(16px);
    }

    .top-left-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .date-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }

    .date-label {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .range-settings {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .range-settings input {
      width: 60px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.45);
      color: var(--text-main);
      font-size: 0.75rem;
      outline: none;
    }

    .range-settings input:focus {
      border-color: rgba(242,197,107,0.7);
      box-shadow: 0 0 0 1px rgba(242,197,107,0.35);
    }

    .backup-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .backup-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .backup-status span.value {
      font-weight: 500;
      color: var(--text-main);
    }

    .backup-status.overdue span.value {
      color: var(--danger);
    }

    .import-label {
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .import-label input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .grid-shell {
      flex: 1;
      background: rgba(10,11,18,0.9);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-soft);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .grid-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--text-muted);
      padding: 0 2px;
    }

    .grid-header-row span.highlight {
      color: var(--gold-soft);
    }

    .grid-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .client-view-banner {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 4px;
    }

    /* „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„ÉºÊôÇ„Å†„ÅëË°®Á§∫ */
    body.client-view-mode #clientViewBanner {
      display: flex;
    }
    body.client-view-mode #clientViewBanner.hidden {
      display: none;
    }

    .status-filter {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
    }

    .status-filter select {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.55);
      color: var(--text-main);
      font-size: 0.75rem;
      outline: none;
    }

    .status-filter select:focus {
      border-color: rgba(242,197,107,0.7);
      box-shadow: 0 0 0 1px rgba(242,197,107,0.35);
    }

    .grid-wrapper {
      flex: 1;
      overflow-x: auto;
      overflow-y: auto;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.04);
      background: radial-gradient(circle at top, rgba(255,255,255,0.04), rgba(10,11,18,0.98) 55%);
    }

    /* „Éñ„É©„Ç¶„Ç∂„ÅÆÈùí„ÅÑ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû„ÇíÊÆ∫„Åô */
    .grid-wrapper,
    .grid-wrapper * {
      user-select: none;
      -webkit-user-select: none;
    }

    table.schedule-grid {
      border-collapse: separate;
      border-spacing: 0;
      width: max(100%, max-content);
      font-size: var(--cell-font-size);
    }

    table.schedule-grid thead {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(to bottom, rgba(8,9,14,0.98), rgba(8,9,14,0.96));
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
    }

    table.schedule-grid th,
    table.schedule-grid td {
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    table.schedule-grid th {
      padding: 6px 6px;
      text-align: left;
      color: var(--text-muted);
      font-size: 0.72rem;
      white-space: nowrap;
      position: relative;
      background-clip: padding-box;
    }

    table.schedule-grid th.row-header {
      min-width: 220px;   /* ‚Üê 180px „Åã„Çâ„Ç¢„ÉÉ„Éó */
      max-width: 280px;
      position: sticky;
      left: 0;
      z-index: 5;
      background: linear-gradient(to right, rgba(10,11,18,0.98), rgba(10,11,18,0.96));
      border-right: 1px solid rgba(255,255,255,0.06);
    }

    table.schedule-grid th.date-header {
      text-align: center;
      min-width: var(--cell-width);
    }

    .date-header-main {
      color: var(--text-main);
      display: block;
      font-weight: 500;
    }

    .date-header-sub {
      font-size: 0.68rem;
      opacity: 0.8;
    }

    .date-header.today {
      background: linear-gradient(to bottom, rgba(242,197,107,0.5), rgba(10,11,18,0.95));
      color: var(--gold-soft);
    }

    .date-header.today .date-header-main {
      color: #fff8e8;
    }

    table.schedule-grid tbody tr:nth-child(even) td.row-header-cell {
      background: rgba(10,11,18,0.96);
    }

    table.schedule-grid tbody tr:nth-child(odd) td.row-header-cell {
      background: rgba(10,11,18,0.9);
    }

    table.schedule-grid td {
      padding: 0;
      background: transparent;
    }

    table.schedule-grid td.row-header-cell {
      position: sticky;
      left: 0;
      z-index: 4;
      border-right: 1px solid rgba(255,255,255,0.06);
    }

    .row-header-inner {
      padding: 4px 6px 4px 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .row-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .row-header-title {
      color: var(--text-main);
      font-weight: 500;
      font-size: 0.8rem;
    }

    .row-header-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .row-header-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(242,197,107,0.35);
      color: var(--gold-soft);
      align-self: flex-start;
      margin-top: 2px;
    }


    .cell {
      position: relative;
      height: var(--cell-height);
      padding: 2px 2px;
      border-left: 1px solid rgba(255,255,255,0.03);
      background: var(--cell-bg);
      transition: background 0.15s ease-out, box-shadow 0.15s ease-out, outline 0.15s ease-out, opacity 0.15s ease-out;
    }

    .cell.today {
      background: linear-gradient(to bottom, rgba(242,197,107,0.7), rgba(242,197,107,0.3));
    }

    .cell-inner {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 3px;
      padding: 0 4px;
    }

    .cell-select {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 1px;
      height: 1px;
      opacity: 0;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: transparent;
      color: var(--text-main);
      font-size: var(--cell-font-size);
      padding: 0;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
    }

    .cell-label {
      position: relative;
      z-index: 1;
      font-size: var(--cell-font-size);
      color: var(--text-main);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: clip;
      flex: 1;
      text-align: center;
    }

    .cell-dropdown-btn {
      position: relative;
      z-index: 1;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.6rem;
      cursor: pointer;
      padding: 0 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 4px;
      flex-shrink: 0;
    }

    .cell-dropdown-btn:hover {
      color: var(--gold-soft);
    }

    .cell.selected {
      outline: 2px solid rgba(242,197,107,0.9);
      outline-offset: -1px;
    }

    .cell-select option {
      background: #111827;
      color: #f9fafb;
    }

    .cell.dim {
      opacity: 0.25;
    }

    .empty-message {
      padding: 16px 14px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .grid-settings {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
      font-size: 0.75rem;
    }

    .grid-settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .grid-settings-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      flex: 1;
    }

    .grid-settings-row input {
      width: 70px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.45);
      color: var(--text-main);
      font-size: 0.75rem;
      outline: none;
    }

    .grid-settings-row input:focus {
      border-color: rgba(242,197,107,0.7);
      box-shadow: 0 0 0 1px rgba(242,197,107,0.35);
    }

    .hidden { display: none !important; }

    .alt-ghost {
      position: fixed;
      z-index: 2000;
      pointer-events: none;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.65);
      color: #fdfdfd;
      font-size: 0.7rem;
      border: 1px solid rgba(242,197,107,0.8);
      box-shadow: 0 8px 18px rgba(0,0,0,0.7);
      opacity: 0.85;
      transform: translate(8px, 8px);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal {
      background: #151722;
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 12px;
      width: min(420px, 92vw);
      font-size: 0.8rem;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 0.86rem;
      font-weight: 600;
    }

    .modal-body {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .status-name-input {
      flex: 1;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.4);
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
    }

    .status-name-input:focus {
      border-color: rgba(242,197,107,0.7);
      box-shadow: 0 0 0 1px rgba(242,197,107,0.35);
    }

    .status-color-input {
      width: 40px;
      height: 24px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      cursor: pointer;
    }

    .status-delete-btn {
      padding-inline: 8px;
    }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      gap: 8px;
    }

    .modal-note {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .context-menu {
      position: fixed;
      z-index: 3000;
      min-width: 150px;
      background: #111827;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.75);
      padding: 4px 0;
      font-size: 0.78rem;
    }

    .context-menu-item {
      padding: 6px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 8px;
    }

    .context-menu-item:hover {
      background: rgba(255,255,255,0.06);
    }

    .context-menu-item span.shortcut {
      color: var(--text-muted);
      font-size: 0.72rem;
    }

    /* ÂÖ•ÂäõÁî®„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
    .input-popover {
      position: fixed;
      z-index: 4000;
      background: #111827;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.75);
      padding: 10px 12px 8px;
      width: 240px;
      font-size: 0.78rem;
    }

    .input-popover-title {
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .input-popover-input {
      width: 100%;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.45);
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
      margin-bottom: 6px;
    }

    .input-popover-input:focus {
      border-color: rgba(242,197,107,0.7);
      box-shadow: 0 0 0 1px rgba(242,197,107,0.35);
    }

    .input-popover-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    /* „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åî„Å®„ÅÆ„Ç∞„É´„Éº„ÉóË°å */
    .project-group-row td {
      padding: 4px 8px;
      background: linear-gradient(to right, rgba(20,20,30,0.98), rgba(20,20,30,0.9));
      border-bottom: 1px solid rgba(255,255,255,0.08);
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .project-group-inner {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .project-group-row {
      cursor: pointer;
    }

    .project-group-row:hover .project-group-inner {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding-inline: 4px;
    }

    .project-group-toggle {
      margin-left: auto;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .row-header-memo-btn {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.4);
      color: var(--text-muted);
      cursor: pointer;
    }

    .row-header-memo-btn:hover {
      border-color: rgba(242,197,107,0.7);
      color: var(--gold-soft);
    }

    /* „Éí„Éº„Éà„Éû„ÉÉ„ÉóÁî® */
    .date-header-heat {
      position: relative;
    }

    .date-header-heat::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(255, 200, 120, 0.0),
        rgba(255, 120, 120, var(--heat-intensity, 0))
      );
      mix-blend-mode: screen;
    }

    /* „Çª„É´„É°„É¢„ÅÆ„Éû„Éº„ÇØ */
    .cell.has-note::after {
      content: "";
      position: absolute;
      right: 2px;
      top: 2px;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--gold-soft);
      box-shadow: 0 0 6px rgba(242,197,107,0.8);
    }

    /* „Çª„É´„É°„É¢Áî®„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
    .cell-tooltip {
      position: fixed;
      z-index: 5000;
      max-width: 260px;
      background: #111827;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 12px 30px rgba(0,0,0,0.8);
      padding: 6px 8px;
      font-size: 0.75rem;
      color: var(--text-main);
      pointer-events: none;
    }

    .cell-tooltip.hidden {
      display: none;
    }

    .project-group-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gold-soft);
    }

    .project-group-deadline {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-left: 12px;
    }

    .project-group-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--gold-soft);
      box-shadow: 0 0 10px rgba(242,197,107,0.7);
    }

    body.hide-row-tags .row-header-tag {
      display: none;
    }

    /* „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„ÉºÁî® */
    body.client-view-mode .sidebar {
      display: none;
    }

    body.client-view-mode .backup-info {
      display: none;
    }

    body.client-view-mode .row-header-actions,
    body.client-view-mode .cell-dropdown-btn {
      display: none;
    }

    body.client-view-mode .grid-settings,
    body.client-view-mode #showAllBtn,
    body.client-view-mode #showSelectedBtn {
      display: none;
    }

    body.client-view-mode .grid-shell {
      border-radius: 12px;
    }

    @media (max-width: 980px) {
      body { padding: 8px; }
      .app-shell {
        flex-direction: column;
        max-height: none;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        flex-shrink: 0;
      }
      .main { padding-top: 10px; }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .backup-info { justify-content: flex-start; }
    }

    @media (max-width: 640px) {
      .app-shell { border-radius: 18px; }
      .sidebar-controls {
        flex-wrap: wrap;
        flex-direction: row;
      }
      .section-label { margin-top: 4px; }
      .app-title-text { max-width: 200px; }
    }

    @media print {
      body {
        padding: 0;
        background: #ffffff;
      }
      .app-shell {
        max-width: none;
        border-radius: 0;
        box-shadow: none;
        border: none;
        background: #ffffff;
      }
      .sidebar { display: none; }
      .main { padding: 12px; }
      .top-bar {
        background: #ffffff;
        border-radius: 0;
        border: none;
        box-shadow: none;
      }
      .grid-shell {
        background: #ffffff;
        border: none;
      }
      .grid-wrapper {
        border: 1px solid #ccc;
        background: #ffffff;
      }
      table.schedule-grid {
        width: 100%;
        color: #000000;
      }
      table.schedule-grid th,
      table.schedule-grid td {
        border-color: #ccc;
      }
      .date-header.today {
        background: #f5f5f5;
      }
      .cell {
        background: #ffffff !important;
      }
      .cell-label {
        color: #000000 !important;
      }
      .cell.selected { outline: none; }
      .cell-dropdown-btn { display: none; }
      .project-group-row td {
        position: static;
        background: #f5f5f5;
      }
    }
        /* Á∑†Âàá„Éò„ÉÉ„ÉÄ„Éº„ÇíËµ§„ÅÑ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Å´„Åó„Å¶„ÄÅ„Çª„É´ÂÅ¥„ÅØÂ§™„ÇÅ„ÅÆÊû†„Å´„Åô„Çã */
        .date-header.deadline {
          background: linear-gradient(
            to bottom,
            rgba(255,120,120,0.85),
            rgba(10,11,18,0.95)
          );
          color: #ffecec;
        }

        .date-header.deadline .date-header-main {
          color: #ffffff;
        }

        .date-header.deadline .date-header-sub {
          color: #ffd1d1;
        }

        /* Ê°à‰ª∂„ÅÆ„Çª„É´ÂÅ¥„ÅØÂ∞ë„ÅóÂ§™„ÇÅ„ÅÆÊû†„Å´„Åô„Çã */
        .cell.deadline-col {
          box-shadow: inset 0 0 0 2px rgba(255,120,120,0.5);
        }

    /* Light theme overrides */
    body.theme-light {
      background: radial-gradient(circle at top left, #f8f9fd 0%, #eef2fb 55%, #e8edf7 100%);
      color: var(--text-main);
    }

    body.theme-light .app-shell {
      background: var(--bg-accent);
      border-color: rgba(0,0,0,0.08);
      box-shadow: var(--shadow-soft);
    }

    body.theme-light .app-shell::before {
      background: radial-gradient(circle at top right, rgba(242,197,107,0.2), transparent 55%);
      mix-blend-mode: normal;
      opacity: 0.8;
    }

    body.theme-light .sidebar {
      background: linear-gradient(160deg, rgba(255,255,255,0.96), rgba(245,246,252,0.95));
      border-right: 1px solid rgba(0,0,0,0.06);
    }

    body.theme-light .project-list {
      background: #ffffff;
      border-color: rgba(0,0,0,0.08);
    }

    body.theme-light .project-item:hover {
      background: rgba(0,0,0,0.04);
    }

    body.theme-light .project-item.active {
      background: rgba(242,197,107,0.18);
      border-color: rgba(193,139,0,0.5);
    }

    body.theme-light .top-bar {
      background: rgba(255,255,255,0.9);
      border-color: rgba(0,0,0,0.08);
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      backdrop-filter: blur(12px);
    }

    body.theme-light .backup-status {
      background: rgba(0,0,0,0.03);
      border-color: rgba(0,0,0,0.06);
    }

    body.theme-light .btn {
      border-color: rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.02);
      color: var(--text-main);
    }

    body.theme-light .btn-soft {
      background: rgba(0,0,0,0.04);
    }

    body.theme-light .btn-soft:hover {
      background: rgba(0,0,0,0.07);
    }

    body.theme-light .btn-ghost {
      border-color: rgba(0,0,0,0.05);
      color: var(--text-muted);
    }

    body.theme-light .btn-ghost.active {
      background: rgba(242,197,107,0.18);
      border-color: rgba(193,139,0,0.45);
      color: #915c00;
    }

    body.theme-light .range-settings input,
    body.theme-light .grid-settings-row input,
    body.theme-light .status-name-input,
    body.theme-light .input-popover-input,
    body.theme-light textarea,
    body.theme-light input[type="number"] {
      background: rgba(0,0,0,0.04);
      border-color: rgba(0,0,0,0.1);
      color: var(--text-main);
    }

    body.theme-light .grid-shell {
      background: #ffffff;
      border-color: rgba(0,0,0,0.08);
    }

    body.theme-light .grid-wrapper {
      background: radial-gradient(circle at top, rgba(0,0,0,0.04), #f7f8fc 55%);
      border-color: rgba(0,0,0,0.06);
    }

    body.theme-light table.schedule-grid thead {
      background: linear-gradient(to bottom, #fdfefe, #eef2fb);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    body.theme-light .date-header-heat::before {
      background: linear-gradient(
        to bottom,
        rgba(255, 190, 120, 0),
        rgba(255, 120, 90, 0.95)
      );
      mix-blend-mode: multiply;
      opacity: var(--heat-intensity, 0);
    }

    body.theme-light table.schedule-grid th,
    body.theme-light table.schedule-grid td {
      border-bottom-color: rgba(0,0,0,0.06);
    }

    body.theme-light table.schedule-grid th.row-header {
      background: linear-gradient(to right, #f8f9fd, #eef2fb);
      border-right-color: rgba(0,0,0,0.06);
    }

    body.theme-light table.schedule-grid tbody tr:nth-child(even) td.row-header-cell {
      background: #f7f8fc;
    }

    body.theme-light table.schedule-grid tbody tr:nth-child(odd) td.row-header-cell {
      background: #ffffff;
    }

    body.theme-light table.schedule-grid td.row-header-cell {
      border-right-color: rgba(0,0,0,0.06);
    }

    body.theme-light .cell {
      background: #ffffff;
      border-left: 1px solid rgba(0,0,0,0.08);
    }

    body.theme-light .cell.today {
      background: linear-gradient(to bottom, rgba(242,197,107,0.4), rgba(242,197,107,0.2));
    }

    body.theme-light .cell-label {
      color: #1f2430 !important;
    }
    body.theme-light .cell-select {
      color: #1f2430 !important;
    }

    body.theme-light .cell-select option {
      background: #ffffff;
      color: #1f2430;
    }

    body.theme-light .modal,
    body.theme-light .context-menu,
    body.theme-light .input-popover,
    body.theme-light .cell-tooltip {
      background: #ffffff;
      border-color: rgba(0,0,0,0.1);
      box-shadow: 0 16px 40px rgba(0,0,0,0.14);
      color: var(--text-main);
    }

    body.theme-light .cell-tooltip {
      color: var(--text-main);
    }

    body.theme-light .project-group-row td {
      background: linear-gradient(to right, #f4f6fb, #eef2fb);
      border-bottom-color: rgba(0,0,0,0.06);
    }

    body.theme-light .row-header-memo-btn {
      background: rgba(0,0,0,0.04);
      border-color: rgba(0,0,0,0.12);
      color: var(--text-muted);
    }

    body.theme-light .row-header-memo-btn:hover {
      border-color: rgba(193,139,0,0.5);
      color: #915c00;
    }

    body.theme-light .row-header-tag {
      border: 1px solid rgba(193,139,0,0.4);
      color: #8a5b00;
      background: #fff6da;
    }

    body.theme-light .project-group-name {
      color: #8a5b00;
    }

    body.theme-light .project-group-dot {
      background: #c28c2c;
      box-shadow: 0 0 10px rgba(193,139,44,0.65);
    }

    body.theme-light .date-header.today {
      background: linear-gradient(to bottom, rgba(242,197,107,0.4), #fffaf0);
      color: #8f5b00;
    }

    body.theme-light .date-header.today .date-header-main {
      color: #7a4d00;
    }

    body.theme-light #trackMemoText,
    body.theme-light #cellNoteTextarea {
      background: rgba(0,0,0,0.04) !important;
      color: var(--text-main) !important;
      border-color: rgba(0,0,0,0.12) !important;
    }

  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="app-title">
        <div class="app-title-text">
          <div class="app-title-main">
            <span class="logo-dot"></span>
            <span>‰ΩúÊõ≤„Çπ„Ç±„Ç∏„É•„Éº„É´„Éú„Éº„Éâ</span>
          </div>
          <div class="app-title-sub">
            Êõ≤„Åî„Å®„ÅÆÂ∑•Á®ã„Çí„ÄÅÈöéÊÆµ„Ç¨„É≥„Éà„Åß„Åñ„Å£„Åè„Çä‰øØÁû∞„Åô„Çã„Åü„ÇÅ„ÅÆ„Éú„Éº„Éâ„ÄÇ
          </div>
        </div>
      </div>

      <div class="sidebar-controls">
        <button class="btn btn-primary" id="addProjectBtn">
          <span class="icon">Ôºã</span> Ê°à‰ª∂„ÇíËøΩÂä†
        </button>
        <button class="btn btn-soft" id="addTrackBtn">
          <span class="icon">‚ô™</span> ÈÅ∏Êäû‰∏≠„ÅÆÊ°à‰ª∂„Å´Êõ≤„ÇíËøΩÂä†
        </button>
        <button class="btn btn-soft" id="editStatusesBtn">
          <span class="icon">üéõ</span> Â∑•Á®ã„É™„Çπ„ÉàÁ∑®ÈõÜ
        </button>
        <button class="btn btn-soft" id="autoStairSortBtn">
          <span class="icon">‚õ∞</span> ÈöéÊÆµ„ÇΩ„Éº„Éà
        </button>
        <div style="display:flex; gap:6px; margin-top:4px; flex-wrap: wrap;">
          <button class="btn btn-ghost btn-sm active" id="showAllBtn">ÂÖ®Ê°à‰ª∂</button>
          <button class="btn btn-ghost btn-sm" id="showSelectedBtn">ÈÅ∏Êäû‰∏≠Ê°à‰ª∂„ÅÆ„Åø</button>
        </div>
      </div>

      <div>
        <div class="section-label">„Ç∞„É™„ÉÉ„ÉâË®≠ÂÆö</div>
        <div class="grid-settings">
          <div class="grid-settings-row">
            <label>
              ÂàóÂπÖ
              <input type="number" id="colWidthInput" min="20" max="200" step="2">
              <span>px</span>
            </label>
          </div>
          <div class="grid-settings-row">
            <label>
              Ë°åÈ´ò
              <input type="number" id="rowHeightInput" min="14" max="80" step="2">
              <span>px</span>
            </label>
          </div>
        </div>
      </div>

      <div>
        <div class="section-label">Ê°à‰ª∂„ÉªÊõ≤„É™„Çπ„Éà</div>
        <div class="project-list" id="projectList"></div>
      </div>
    </aside>

    <main class="main">
      <div class="top-bar">
        <div class="top-left-group">
          <div class="date-controls">
            <button class="btn btn-soft btn-sm" id="prevRangeBtn">
              <span class="icon">‚óÄ</span> Ââç„Å∏
            </button>
            <span class="date-label" id="dateRangeLabel">---</span>
            <button class="btn btn-soft btn-sm" id="nextRangeBtn">
              Ê¨°„Å∏ <span class="icon">‚ñ∂</span>
            </button>
            
          </div>
          <div class="range-settings">
            <span>Ë°®Á§∫Êó•Êï∞</span>
            <input type="number" id="daysToShowInput" min="7" max="90" step="1">
            <span>Êó•</span>
          </div>
        </div>
        <div class="backup-info">
          <button class="btn btn-soft btn-sm" id="tagToggleBtn">
            üè∑ „Çø„Ç∞ÈùûË°®Á§∫
          </button>
          <button class="btn btn-soft btn-sm" id="themeToggleBtn">
            ‚òÄÔ∏è „É©„Ç§„Éà„É¢„Éº„Éâ
          </button>
          <div class="backup-status" id="backupStatus">
            <span>ÊúÄÁµÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</span>
            <span class="value" id="backupStatusText">„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</span>
          </div>
          <button class="btn btn-soft btn-sm" id="undoBtn">
            <span class="icon">‚Ü∂</span> ÂÖÉ„Å´Êàª„Åô
          </button>
          <button class="btn btn-soft btn-sm" id="clientViewToggleBtn">
            üëÅ „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„Éº
          </button>
          <button class="btn btn-soft btn-sm" id="exportBtn">
            <span class="icon">üíæ</span> JSONÊõ∏„ÅçÂá∫„Åó
          </button>
          <label class="btn btn-soft btn-sm import-label">
            <span class="icon">üìÇ</span> JSONË™≠„ÅøËæº„Åø
            <input type="file" id="importInput" accept="application/json">
          </label>

        </div>
      </div>

      <div class="grid-shell">
        <div class="grid-header-row">
          <span>Ë°åÔºö<span class="highlight">Ê°à‰ª∂ √ó Êõ≤</span> / ÂàóÔºö<span class="highlight">Êó•‰ªò</span></span>
          <div class="grid-header-right">
            <span>„Çª„É´ÂÜÖÔºöÂ∑•Á®ãÔºà‰ΩúÊõ≤„ÉªMIX„Éª„É™„Éü„ÉÉ„ÇØ„Çπ„Å™„Å©Ëá™Áî±„Å´„Ç´„Çπ„Çø„É†Ôºâ</span>
            <div class="status-filter">
              <span>Â∑•Á®ã„Éï„Ç£„É´„ÇøÔºö</span>
              <select id="statusFilterSelect">
                <option value="ALL">„Åô„Åπ„Å¶</option>
              </select>
            </div>
            <button class="btn btn-ghost btn-sm" id="heatmapToggleBtn">
              üî• Ë≤†Ëç∑„Éí„Éº„Éà„Éû„ÉÉ„Éó ON
            </button>
          </div>
        </div>

        <div id="clientViewBanner" class="client-view-banner hidden">
          <span>„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„ÉºË°®Á§∫‰∏≠</span>
          <button class="btn btn-soft btn-sm" id="clientViewBackBtn">
            ÈÄöÂ∏∏„Éì„É•„Éº„Å´Êàª„Çã
          </button>
        </div>

        <div class="grid-wrapper" id="gridWrapper">
          <!-- JS „Åß„ÉÜ„Éº„Éñ„É´„ÇíÊèèÁîª -->
        </div>
      </div>
    </main>
  </div>

  <!-- Â∑•Á®ã„É™„Çπ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay hidden" id="statusEditorOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Â∑•Á®ã„É™„Çπ„ÉàÁ∑®ÈõÜ</div>
        <button class="btn btn-ghost btn-sm" id="closeStatusEditorBtn">‚úï</button>
      </div>
      <div class="modal-body" id="statusListContainer">
        <!-- JS„ÅßË°å„ÇíÁîüÊàê -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-soft btn-sm" id="addStatusRowBtn">
          <span class="icon">Ôºã</span> Â∑•Á®ã„ÇíËøΩÂä†
        </button>
        <div style="display:flex; gap:6px; align-items:center;">
          <span class="modal-note">‚ÄªÁ©∫Ê¨Ñ„ÅÆË°å„ÅØÁÑ°Ë¶ñ„Åï„Çå„Åæ„Åô„ÄÇ</span>
          <button class="btn btn-primary btn-sm" id="saveStatusesBtn">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Âè≥„ÇØ„É™„ÉÉ„ÇØÁî®„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº -->
  <div id="contextMenu" class="context-menu hidden">
    <div class="context-menu-item" data-action="copy">
      „Ç≥„Éî„Éº <span class="shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-item" data-action="paste">
      Ë≤º„Çä‰ªò„Åë <span class="shortcut">Ctrl+V</span>
    </div>
    <div class="context-menu-item" data-action="clear">
      ÂâäÈô§ <span class="shortcut">Del / Backspace</span>
    </div>
  </div>

  <!-- Ê°à‰ª∂„ÉªÊõ≤ÂêçÂÖ•ÂäõÁî®„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
  <div id="inputPopover" class="input-popover hidden">
    <div class="input-popover-title" id="inputPopoverTitle"></div>
    <input type="text" id="inputPopoverField" class="input-popover-input">
    <div class="input-popover-actions">
      <button class="btn btn-ghost btn-sm" id="inputPopoverCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary btn-sm" id="inputPopoverOkBtn">ËøΩÂä†</button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'composerScheduleBoard_v10';

    const DEFAULT_STATUSES = [
      { name: '‰ΩúÊõ≤',      color: '#f5576c' },
      { name: '„Ç¢„É¨„É≥„Ç∏',  color: '#84fab0' },
      { name: 'REC',      color: '#ff9a9e' },
      { name: 'MIX',      color: '#a18cd1' },
      { name: '„Éû„Çπ„Çø„É™„É≥„Ç∞', color: '#f6d365' },
      { name: 'ÊµÑÊõ∏',      color: '#fda085' },
      { name: '‰øÆÊ≠£',      color: '#f093fb' },
      { name: 'Êâì„Å°Âêà„Çè„Åõ',  color: '#4facfe' }
    ];

    const DEFAULT_DAYS_TO_SHOW = 21;

    function detectPreferredTheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
        return 'light';
      }
      return 'dark';
    }

    let selectedProjectId = null;
    let showOnlySelected = false;

    let selectedCells = new Set(); // "trackId|date"
    let isSelecting = false;
    let isAltDragging = false;
    let altDragSource = null;
    let altDragGhostEl = null;
    let lastFocusedCell = null;
    let clipboardData = null;

    let currentRows = [];
    let currentDates = [];
    let trackIdToRowIndex = {};
    let dateToColIndex = {};

    let contextMenuTarget = null;
    let trackMemoState = { projectId: null, trackId: null };
    let cellNoteState = { trackId: null, date: null };

    // ÂÖ•Âäõ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÁä∂ÊÖã
    let inputPopoverState = {
      type: null,
      anchorBtn: null
    };

    // Â∑•Á®ã„Éï„Ç£„É´„Çø
    let currentStatusFilter = 'ALL';

    // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„Éº
    let clientViewMode = false;

    // Undo „Çπ„Çø„ÉÉ„ÇØ
    let undoStack = [];
    const UNDO_LIMIT = 20;

    let state = loadStateOrInit();

    ensureSettingsObject();
    if (!state.settings.theme) {
      state.settings.theme = detectPreferredTheme();
      saveState();
    }
    applyTheme(state.settings.theme);
    applyTagVisibility(state.settings.showProjectTags);

    function toDateOnly(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function formatDateISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function parseISO(dateStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function addDays(date, days) {
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + days);
      return d;
    }

    function formatDisplayDate(date) {
      const weekdays = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
      const m = date.getMonth() + 1;
      const d = date.getDate();
      const w = weekdays[date.getDay()];
      return `${m}/${d}Ôºà${w}Ôºâ`;
    }

    function formatDateTimeForLabel(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const mm = String(date.getMinutes()).padStart(2, '0');
      return `${y}/${m}/${d} ${hh}:${mm}`;
    }

    function generateId() {
      return 'id_' + Math.random().toString(36).slice(2, 9) + '_' + Date.now().toString(36);
    }

    function loadStateOrInit() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const today = toDateOnly(new Date());
        const sampleProjectId = generateId();
        const trackA = generateId();
        const trackB = generateId();

        return {
          startDate: formatDateISO(today),
          daysToShow: DEFAULT_DAYS_TO_SHOW,
          lastBackupAt: null,
          projects: [
            {
              id: sampleProjectId,
              name: '„Çµ„É≥„Éó„É´Ê°à‰ª∂',
              color: '#f2c56b',
              collapsed: false,
              archived: false,
              tracks: [
                { id: trackA, name: 'Main Theme', memo: '' },
                { id: trackB, name: 'Ending', memo: '' }
              ]
            }
          ],
          schedule: {
            [trackA]: {
              [formatDateISO(today)]: '‰ΩúÊõ≤',
              [formatDateISO(addDays(today, 1))]: '‰ΩúÊõ≤',
              [formatDateISO(addDays(today, 2))]: 'MIX'
            },
            [trackB]: {
              [formatDateISO(addDays(today, 3))]: '‰ΩúÊõ≤',
              [formatDateISO(addDays(today, 4))]: 'REC'
            }
          },
          statuses: DEFAULT_STATUSES,
          settings: {
            cellWidth: 70,
            cellHeight: 28,
            heatmapEnabled: true,
            showProjectTags: true,
            theme: detectPreferredTheme()
          },
          cellNotes: {}
        };
      }

      try {
        const obj = JSON.parse(raw);
        if (!obj.projects) throw new Error('invalid data');
        // Ë£úÂÆå: Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÊã°Âºµ
        if (!obj.settings) obj.settings = {};
        if (typeof obj.settings.cellWidth !== 'number') obj.settings.cellWidth = 70;
        if (typeof obj.settings.cellHeight !== 'number') obj.settings.cellHeight = 28;
        if (typeof obj.settings.heatmapEnabled !== 'boolean') obj.settings.heatmapEnabled = true;
        if (typeof obj.settings.showProjectTags !== 'boolean') obj.settings.showProjectTags = true;
        if (!obj.settings.theme) obj.settings.theme = detectPreferredTheme();

        if (!obj.cellNotes) obj.cellNotes = {};

        obj.projects.forEach(p => {
          if (typeof p.collapsed !== 'boolean') p.collapsed = false;
          if (typeof p.archived !== 'boolean') p.archived = false;
          (p.tracks || []).forEach(t => {
            if (typeof t.memo !== 'string') t.memo = '';
          });
        });
        
        if (!obj.daysToShow) obj.daysToShow = DEFAULT_DAYS_TO_SHOW;
        if (!obj.statuses || !Array.isArray(obj.statuses) || obj.statuses.length === 0) {
          obj.statuses = DEFAULT_STATUSES;
        }
        return obj;
      } catch (e) {
        console.warn('failed to parse state, init new', e);
        localStorage.removeItem(STORAGE_KEY);
        return loadStateOrInit();
      }
    }

        function normalizeImportedState(data) {
      // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„Åå„Å™„Åã„Å£„Åü„Çâ„Ç®„É©„Éº„Å´„Åó„Å¶„Åä„Åè
      if (!data || !Array.isArray(data.projects)) {
        throw new Error('invalid data');
      }

      // daysToShow / statuses „ÅÆË£úÂÆå
      if (!data.daysToShow) data.daysToShow = DEFAULT_DAYS_TO_SHOW;
      if (!data.statuses || !Array.isArray(data.statuses) || data.statuses.length === 0) {
        data.statuses = DEFAULT_STATUSES;
      }

      // settings „ÅÆË£úÂÆå
      if (!data.settings) data.settings = {};
      if (typeof data.settings.cellWidth !== 'number') data.settings.cellWidth = 70;
      if (typeof data.settings.cellHeight !== 'number') data.settings.cellHeight = 28;
      if (typeof data.settings.heatmapEnabled !== 'boolean') {
        data.settings.heatmapEnabled = true;
      }
      if (typeof data.settings.showProjectTags !== 'boolean') {
        data.settings.showProjectTags = true;
      }
      if (!data.settings.theme) {
        data.settings.theme = detectPreferredTheme();
      }

      // cellNotes „ÅÆË£úÂÆåÔºàÂè§„ÅÑ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å†„Å®Â≠òÂú®„Åó„Å™„ÅÑÔºâ
      if (!data.cellNotes || typeof data.cellNotes !== 'object') {
        data.cellNotes = {};
      }

      // ÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éª„Éà„É©„ÉÉ„ÇØ„ÅÆË£úÂÆå
      data.projects.forEach(p => {
        if (typeof p.collapsed !== 'boolean') p.collapsed = false;
        if (typeof p.archived !== 'boolean') p.archived = false;
        if (!Array.isArray(p.tracks)) p.tracks = [];
        p.tracks.forEach(t => {
          if (typeof t.memo !== 'string') t.memo = '';
        });
      });

      // schedule „Åå„Å™„Åë„Çå„Å∞Á©∫„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
      if (!data.schedule || typeof data.schedule !== 'object') {
        data.schedule = {};
      }

      return data;
    }


    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function pushUndo() {
      const snapshot = JSON.parse(JSON.stringify(state));
      undoStack.push(snapshot);
      if (undoStack.length > UNDO_LIMIT) {
        undoStack.shift();
      }
    }

    function undoLast() {
      if (!undoStack.length) return;
      state = undoStack.pop();
      saveState();
      selectedCells.clear();
      lastFocusedCell = null;
      clipboardData = null;
      applyTagVisibility(state.settings.showProjectTags);
      applyTheme(state.settings.theme);
      renderAll();
    }

    function getStatusOptions() {
      return ['', ...state.statuses.map(s => s.name)];
    }

    function findStatusByName(name) {
      if (!name) return null;
      return state.statuses.find(s => s.name === name) || null;
    }

    function hexToRgb(hex) {
      if (!hex) return null;
      const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      if (!m) return null;
      return {
        r: parseInt(m[1], 16),
        g: parseInt(m[2], 16),
        b: parseInt(m[3], 16)
      };
    }

    function styleCellSelect(selectEl) {
      const value = selectEl.value;
      const status = findStatusByName(value);
      const cell = selectEl.closest('.cell');
      if (!cell) return;

      const label = cell.querySelector('.cell-label');
      if (label) {
        label.textContent = value || '';
      }

      const rootStyles = getComputedStyle(document.body);
      const textColor = (rootStyles.getPropertyValue('--text-main').trim() || '#fdfdfd');
      const baseBgNormal = (rootStyles.getPropertyValue('--cell-bg').trim() || 'rgba(5,6,11,0.7)');

      const isLightTheme = document.body.classList.contains('theme-light');
      const isToday = cell.classList.contains('today');
      const baseBgToday = isLightTheme
        ? 'linear-gradient(to bottom, rgba(242,197,107,0.45), rgba(242,197,107,0.2))'
        : 'linear-gradient(to bottom, rgba(242,197,107,0.7), rgba(242,197,107,0.3))';
      const defaultBorder = isLightTheme ? 'rgba(0,0,0,0.12)' : 'rgba(255,255,255,0.16)';

      if (!status) {
        cell.style.background = isToday ? baseBgToday : baseBgNormal;
        selectEl.style.borderColor = defaultBorder;
        if (label) label.style.color = textColor;
        return;
      }

      const rgb = hexToRgb(status.color) || { r: 242, g: 197, b: 107 };
      const r = rgb.r, g = rgb.g, b = rgb.b;

      let bg;
      if (isToday) {
        bg = isLightTheme
          ? `linear-gradient(to bottom, rgba(${r},${g},${b},0.55), rgba(${r},${g},${b},0.3))`
          : `linear-gradient(to bottom, rgba(${r},${g},${b},0.9), rgba(${r},${g},${b},0.5))`;
      } else {
        bg = isLightTheme
          ? `linear-gradient(135deg, rgba(${r},${g},${b},0.16), rgba(${r},${g},${b},0.42))`
          : `linear-gradient(135deg, rgba(${r},${g},${b},0.22), rgba(${r},${g},${b},0.6))`;
      }
      cell.style.background = bg;
      selectEl.style.borderColor = `rgba(${r},${g},${b},${isLightTheme ? 0.7 : 0.85})`;

      if (label) {
        label.style.color = isLightTheme ? '#1f2430' : '#fdfdfd';
      }
    }

    function styleAllCellSelects() {
      document.querySelectorAll('.cell-select').forEach(styleCellSelect);
    }

    function cellKey(trackId, date) {
      return trackId + '|' + date;
    }

    function updateSelectionStyles() {
      document.querySelectorAll('.cell').forEach(cell => {
        const t = cell.dataset.trackId;
        const d = cell.dataset.date;
        const key = (t && d) ? cellKey(t, d) : null;
        if (key && selectedCells.has(key)) {
          cell.classList.add('selected');
        } else {
          cell.classList.remove('selected');
        }
      });
    }

    let selectionAnchorCoords = null;

    function setSelectionRectangle(anchor, target) {
      if (!currentRows.length || !currentDates.length) return;
      const minRow = Math.min(anchor.rowIndex, target.rowIndex);
      const maxRow = Math.max(anchor.rowIndex, target.rowIndex);
      const minCol = Math.min(anchor.colIndex, target.colIndex);
      const maxCol = Math.max(anchor.colIndex, target.colIndex);

      selectedCells.clear();
      for (let r = minRow; r <= maxRow; r++) {
        if (!currentRows[r]) continue;
        const track = currentRows[r].track;
        for (let c = minCol; c <= maxCol; c++) {
          if (!currentDates[c]) continue;
          const dateIso = formatDateISO(currentDates[c]);
          selectedCells.add(cellKey(track.id, dateIso));
        }
      }
      updateSelectionStyles();
    }

    function getSelectedCellCoords() {
      const coords = [];
      selectedCells.forEach(key => {
        const [trackId, date] = key.split('|');
        const rowIndex = trackIdToRowIndex[trackId];
        const colIndex = dateToColIndex[date];
        if (rowIndex != null && colIndex != null) {
          coords.push({ trackId, date, rowIndex, colIndex });
        }
      });
      return coords;
    }

    function renderProjects() {
      const container = document.getElementById('projectList');
      container.innerHTML = '';

      const activeProjects = state.projects.filter(p => !p.archived);
      const archivedProjects = state.projects.filter(p => p.archived);

      if (!activeProjects.length && !archivedProjects.length) {
        container.innerHTML = `
          <div class="empty-message">
            <strong>„Åæ„Å†Ê°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</strong><br>
            „ÄåÊ°à‰ª∂„ÇíËøΩÂä†„Äç„Åã„Çâ‰ΩúÊàê„Åó„Å¶„ÄÅÊõ≤„ÇíÁôªÈå≤„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </div>
        `;
        return;
      }

      // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê°à‰ª∂
      activeProjects.forEach(project => {
        const tracksCount = (project.tracks || []).length;
        const div = document.createElement('div');
        div.className = 'project-item' + (project.id === selectedProjectId ? ' active' : '');
        div.dataset.projectId = project.id;
        div.innerHTML = `
          <div class="project-name">
            <span class="project-dot" style="background:${project.color || '#f2c56b'}"></span>
            <span>${escapeHtml(project.name)}</span>
          </div>
          <div style="display:flex; align-items:center; gap:4px;">
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-up-btn"
                    data-project-id="${project.id}"
                    title="‰∏ä„Å∏">
              ‚ñ≤
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-move-down-btn"
                    data-project-id="${project.id}"
                    title="‰∏ã„Å∏">
              ‚ñº
            </button>
            <div class="project-meta">${tracksCount}Êõ≤</div>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-archive-btn"
                    data-project-id="${project.id}"
                    title="Ê°à‰ª∂„Çí„Ç¢„Éº„Ç´„Ç§„Éñ">
              üì¶
            </button>
            <button type="button"
                    class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                    data-project-id="${project.id}"
                    title="Ê°à‰ª∂„ÇíÂâäÈô§">
              üóë
            </button>
          </div>
        `;
        div.addEventListener('click', (e) => {
          if (e.target.closest('.project-delete-btn') ||
              e.target.closest('.project-move-up-btn') ||
              e.target.closest('.project-move-down-btn') ||
              e.target.closest('.project-archive-btn')) {
            return;
          }
          selectedProjectId = project.id;
          updateFilterButtons();
          renderAll();
        });
        container.appendChild(div);
      });

      // „Ç¢„Éº„Ç´„Ç§„Éñ„Åï„Çå„ÅüÊ°à‰ª∂
      if (archivedProjects.length) {
        const archiveSection = document.createElement('div');
        archiveSection.style.marginTop = '20px';
        archiveSection.style.borderTop = '1px solid #e0e0e0';
        archiveSection.style.paddingTop = '10px';
        const archiveTitle = document.createElement('div');
        archiveTitle.style.fontSize = '12px';
        archiveTitle.style.fontWeight = 'bold';
        archiveTitle.style.color = '#999';
        archiveTitle.style.marginBottom = '8px';
        archiveTitle.textContent = '„Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø';
        archiveSection.appendChild(archiveTitle);

        archivedProjects.forEach(project => {
          const tracksCount = (project.tracks || []).length;
          const div = document.createElement('div');
          div.className = 'project-item archived';
          div.dataset.projectId = project.id;
          div.style.opacity = '0.6';
          div.innerHTML = `
            <div class="project-name">
              <span class="project-dot" style="background:${project.color || '#f2c56b'}"></span>
              <span>${escapeHtml(project.name)}</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
              <div class="project-meta">${tracksCount}Êõ≤</div>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-unarchive-btn"
                      data-project-id="${project.id}"
                      title="„Ç¢„Éº„Ç´„Ç§„Éñ„ÇíËß£Èô§">
                ‚Ü©Ô∏è
              </button>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-icon-only project-delete-btn"
                      data-project-id="${project.id}"
                      title="Ê°à‰ª∂„ÇíÂâäÈô§">
                üóë
              </button>
            </div>
          `;
          archiveSection.appendChild(div);
        });

        container.appendChild(archiveSection);
      }

      // Ê°à‰ª∂ÂâäÈô§
      container.querySelectorAll('.project-delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const projectId = btn.dataset.projectId;
          const project = state.projects.find(p => p.id === projectId);
          if (!project) return;
          const ok = window.confirm(`Ê°à‰ª∂„Äå${project.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºàÊ°à‰ª∂ÂÜÖ„ÅÆÊõ≤„Å®„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇÇ„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„ÅôÔºâ`);
          if (!ok) return;

          pushUndo();

          (project.tracks || []).forEach(track => {
            if (state.schedule[track.id]) {
              delete state.schedule[track.id];
            }
          });

          state.projects = state.projects.filter(p => p.id !== projectId);

          if (selectedProjectId === projectId) {
            selectedProjectId = state.projects.length ? state.projects.find(p => !p.archived)?.id || state.projects[0].id : null;
          }

          saveState();
          selectedCells.clear();
          lastFocusedCell = null;
          clipboardData = null;
          renderAll();
        });
      });

      // Ê°à‰ª∂„Ç¢„Éº„Ç´„Ç§„Éñ
      container.querySelectorAll('.project-archive-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const projectId = btn.dataset.projectId;
          const project = state.projects.find(p => p.id === projectId);
          if (!project) return;

          pushUndo();
          project.archived = true;
          if (selectedProjectId === projectId) {
            selectedProjectId = state.projects.find(p => !p.archived)?.id || null;
          }
          saveState();
          renderAll();
        });
      });

      // „Ç¢„Éº„Ç´„Ç§„ÉñËß£Èô§
      container.querySelectorAll('.project-unarchive-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const projectId = btn.dataset.projectId;
          const project = state.projects.find(p => p.id === projectId);
          if (!project) return;

          pushUndo();
          project.archived = false;
          saveState();
          renderAll();
        });
      });

      // Ê°à‰ª∂‰∏¶„Å≥Êõø„ÅàÔºà‰∏ä„Å∏Ôºè‰∏ã„Å∏Ôºâ
      container.querySelectorAll('.project-move-up-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          moveProject(btn.dataset.projectId, -1);
        });
      });
      container.querySelectorAll('.project-move-down-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          moveProject(btn.dataset.projectId, 1);
        });
      });
    }

    function moveProject(projectId, delta) {
      const idx = state.projects.findIndex(p => p.id === projectId);
      if (idx < 0) return;
      const newIdx = idx + delta;
      if (newIdx < 0 || newIdx >= state.projects.length) return;

      pushUndo();

      const [p] = state.projects.splice(idx, 1);
      state.projects.splice(newIdx, 0, p);
      saveState();
      renderAll();
    }

    function buildDateRange() {
      const start = parseISO(state.startDate);
      const days = state.daysToShow || DEFAULT_DAYS_TO_SHOW;
      const dates = [];
      for (let i = 0; i < days; i++) {
        const d = addDays(start, i);
        dates.push(d);
      }
      return dates;
    }

    function renderDateRangeLabel() {
      const dates = buildDateRange();
      const labelEl = document.getElementById('dateRangeLabel');

      if (!dates.length) {
        labelEl.textContent = '---';
      } else {
        const first = dates[0];
        const last = dates[dates.length - 1];
        const label =
          `${first.getFullYear()}/${first.getMonth() + 1}/${first.getDate()} „Äú ` +
          `${last.getFullYear()}/${last.getMonth() + 1}/${last.getDate()}`;
        labelEl.textContent = label;
      }

      const daysInput = document.getElementById('daysToShowInput');
      if (daysInput) {
        daysInput.value = state.daysToShow || DEFAULT_DAYS_TO_SHOW;
      }
    }

    function getFlatRows() {
      const rows = [];
      state.projects.forEach(project => {
        if (project.archived) return; // „Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„ÅøÊ°à‰ª∂„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        if (showOnlySelected && selectedProjectId && project.id !== selectedProjectId) return;
        (project.tracks || []).forEach(track => {
          rows.push({ project, track });
        });
      });
      return rows;
    }

     // „Éí„Éº„Éà„Éû„ÉÉ„ÉóÁî®ÔºöÂêÑÊó•‰ªò„ÅÆ‰ΩúÊ•≠Èáè„ÇíË®àÁÆóÔºà„Éà„É©„ÉÉ„ÇØ √ó Êó•‰ªò „Åß 1 „Ç´„Ç¶„É≥„ÉàÔºâ
    // state.schedule „ÅØ„ÄåtrackId „Åî„Å®„ÅÆ { Êó•‰ªòISO: Â∑•Á®ãÂêç }„Äç„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ
    // „Åù„Çå„Å´Âêà„Çè„Åõ„Å¶„Ç∑„É≥„Éó„É´„Å´„Ç´„Ç¶„É≥„Éà„Åó„Åæ„Åô„ÄÇ
    function computeColumnLoads(dates, rows) {
      const loads = {};
      const isoDates = dates.map(d => formatDateISO(d));

      isoDates.forEach(iso => {
        loads[iso] = 0;
      });

      rows.forEach(({ track }) => {
        const sched = state.schedule[track.id] || {};
        isoDates.forEach(iso => {
          const value = sched[iso];
          if (value && value !== 'none') {
            loads[iso] += 1;
          }
        });
      });

      return loads;
    }


        function renderGrid() {
      const wrapper = document.getElementById('gridWrapper');
      const dates = buildDateRange();
      const rows = getFlatRows();

      // ÁèæÂú®„ÅÆË°å„ÉªÂàóÊÉÖÂ†±„ÇíÊõ¥Êñ∞
      currentRows = rows;
      currentDates = dates;
      trackIdToRowIndex = {};
      dateToColIndex = {};

      rows.forEach((rt, idx) => {
        trackIdToRowIndex[rt.track.id] = idx;
      });
      dates.forEach((d, idx) => {
        dateToColIndex[formatDateISO(d)] = idx;
      });

      if (!rows.length) {
        wrapper.innerHTML = `
          <div class="empty-message">
            <strong>Ë°®Á§∫„Åô„ÇãÊõ≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</strong><br>
            Â∑¶„ÅÆ„ÄåÊ°à‰ª∂„ÇíËøΩÂä†„Äç‚Üí„ÄåÊõ≤„ÇíËøΩÂä†„Äç„ÅßÊõ≤„ÇíÁôªÈå≤„Åô„Çã„Å®„ÄÅ
            „Åì„Åì„Å´ <strong>Ê°à‰ª∂ √ó Êõ≤ √ó Êó•‰ªò</strong> „ÅÆ„Ç∞„É™„ÉÉ„Éâ„ÅåÂá∫„Å¶„Åç„Åæ„Åô„ÄÇ
          </div>
        `;
        return;
      }

      const todayIso = formatDateISO(toDateOnly(new Date()));
      const statusOptions = getStatusOptions();

      // üî¥ Ê°à‰ª∂„Åî„Å®„ÅÆÁ∑†Âàá„Éû„ÉÉ„Éó
      const projectDeadlineMap = {};
      state.projects.forEach(p => {
        if (p.deadline) projectDeadlineMap[p.id] = p.deadline;
      });

      // üî• „Éí„Éº„Éà„Éû„ÉÉ„ÉóÁî®„ÅÆ‰ΩúÊ•≠Èáè
      const heatmapEnabled = state.settings && state.settings.heatmapEnabled;
      const columnLoads = heatmapEnabled ? computeColumnLoads(dates, rows) : {};
      let maxLoad = 0;
      if (heatmapEnabled) {
        Object.values(columnLoads).forEach(v => {
          if (v > maxLoad) maxLoad = v;
        });
        if (maxLoad < 1) maxLoad = 1;
      }

      // „ÉÜ„Éº„Éñ„É´„ÅÆ HTML „ÇíÊßãÁØâ
      let html = '<table class="schedule-grid"><thead><tr>';

      // Â∑¶‰∏ä„ÅÆÂõ∫ÂÆö„Éò„ÉÉ„ÉÄ„Éº
      html += '<th class="row-header"></th>';

      // Êó•‰ªò„Éò„ÉÉ„ÉÄ„Éº
      dates.forEach(d => {
        const iso = formatDateISO(d);
        const isToday = iso === todayIso;
        const isDeadlineHeader = Object.values(projectDeadlineMap).includes(iso);

        let heatIntensity = 0;
        if (heatmapEnabled) {
          const count = columnLoads[iso] || 0;
          // 5„Çª„É´‰ª•‰∏ä„Åß„Åª„ÅºÊúÄÂ§ß„Å´„Å™„Çã„Çà„ÅÜ„Å™„Çπ„Ç±„Éº„É™„É≥„Ç∞
          heatIntensity = Math.max(0, Math.min(1, count / 5));
        }

        const headerClasses = [
          'date-header',
          'date-header-heat',     // CSS „ÅÆ ::before „Åß„Éí„Éº„Éà„Éû„ÉÉ„ÉóË°®Á§∫
          isToday ? 'today' : '',
          isDeadlineHeader ? 'deadline' : ''
        ].filter(Boolean).join(' ');

        html += `
          <th class="${headerClasses}"
              data-date="${iso}"
              style="--heat-intensity:${heatIntensity};">
            <span class="date-header-main">${formatDisplayDate(d)}</span>
            <span class="date-header-sub">${iso}</span>
          </th>
        `;
      });

      html += '</tr></thead><tbody>';

      // Ê°à‰ª∂„Åî„Å®„ÅÆ„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê
      const groups = [];
      state.projects.forEach(project => {
        if (project.archived) return; // „Ç¢„Éº„Ç´„Ç§„ÉñÊ°à‰ª∂„ÅØ„Ç∞„É™„ÉÉ„Éâ„Åã„ÇâÈô§Â§ñ
        if (showOnlySelected && selectedProjectId && project.id !== selectedProjectId) return;
        const tracks = (project.tracks || []).filter(t => trackIdToRowIndex[t.id] != null);
        if (!tracks.length) return;
        groups.push({ project, tracks });
      });

      groups.forEach(group => {
        const project = group.project;
        const projectDeadlineIso = projectDeadlineMap[project.id] || null;
        const projectDeadlineText = project.deadline
          ? `Á∑†Âàá: ${project.deadline}`
          : 'Á∑†Âàá: Êú™Ë®≠ÂÆö';
        const isCollapsed = !!project.collapsed;

        // „Ç∞„É´„Éº„ÉóË°åÔºàNotionÈ¢®„Éà„Ç∞„É´ÔºãÊ°à‰ª∂Á∑†ÂàáË°®Á§∫ÔºãÁ∑†Âàá„Éú„Çø„É≥Ôºâ
        html += `
          <tr class="project-group-row" data-project-id="${project.id}">
            <td class="project-group-cell" colspan="${dates.length + 1}">
              <div class="project-group-inner">
                <span class="project-group-dot" style="background:${project.color || '#f2c56b'}"></span>
                <span class="project-group-name">${escapeHtml(project.name)}</span>
                <span class="project-group-deadline">${projectDeadlineText}</span>
                <button type="button"
                        class="btn btn-ghost btn-sm project-deadline-btn"
                        data-project-id="${project.id}"
                        title="„Åì„ÅÆÊ°à‰ª∂„ÅÆÁ∑†ÂàáÊó•„ÇíË®≠ÂÆö">
                  ‚è±
                </button>
                <span class="project-group-toggle">
                  ${isCollapsed ? '‚ñ∂' : '‚ñº'}
                </span>
              </div>
            </td>
          </tr>
        `;

        // Êäò„Çä„Åü„Åü„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ≤Ë°å„ÇíÊèè„Åã„Å™„ÅÑ
        if (isCollapsed) {
          return;
        }

        // Ê°à‰ª∂ÂÜÖ„ÅÆÂêÑ„Éà„É©„ÉÉ„ÇØË°å
        group.tracks.forEach(track => {
          const rowIndex = trackIdToRowIndex[track.id];
          const trackSchedule = state.schedule[track.id] || {};

          html += '<tr>';

          // Ë°å„Éò„ÉÉ„ÉÄ„ÉºÔºàÊõ≤Âêç„Éª„É°„É¢„Éú„Çø„É≥„Éª‰∏¶„Å≥Êõø„Åà„ÉªÂâäÈô§Ôºâ
          html += `
            <td class="row-header-cell">
              <div class="row-header-inner">
                <div class="row-header-top">
                  <div class="row-header-title">${escapeHtml(track.name)}</div>
                  <div class="row-header-actions">
                    <button type="button"
                            class="btn btn-ghost btn-sm btn-icon-only row-header-memo-btn"
                            data-project-id="${project.id}"
                            data-track-id="${track.id}"
                            title="${escapeHtml(track.memo || '„É°„É¢Êú™Ë®≠ÂÆö')}">
                      üìù
                    </button>
                    <button type="button"
                            class="btn btn-ghost btn-sm btn-icon-only row-move-up-btn"
                            data-project-id="${project.id}"
                            data-track-id="${track.id}"
                            title="‰∏ä„Å∏">
                      ‚ñ≤
                    </button>
                    <button type="button"
                            class="btn btn-ghost btn-sm btn-icon-only row-move-down-btn"
                            data-project-id="${project.id}"
                            data-track-id="${track.id}"
                            title="‰∏ã„Å∏">
                      ‚ñº
                    </button>
                    <button type="button"
                            class="btn btn-ghost btn-sm btn-icon-only row-delete-btn"
                            data-track-id="${track.id}"
                            title="„Åì„ÅÆÊõ≤„ÇíÂâäÈô§">
                      üóë
                    </button>
                  </div>
                </div>
                <div class="row-header-tag">${escapeHtml(project.name)}</div>
              </div>
            </td>
          `;

          // ÂêÑ„Çª„É´
          dates.forEach((d, colIndex) => {
            const iso = formatDateISO(d);
            const isToday = iso === todayIso;
            const isDeadlineCol = projectDeadlineIso && projectDeadlineIso === iso;
            const value = trackSchedule[iso] || '';
            const key = cellKey(track.id, iso);
            const isSelected = selectedCells.has(key);
            const cellNoteKey = cellKey(track.id, iso);
            const hasNote = state.cellNotes[cellNoteKey];

            const cellClasses = [
              'cell',
              isToday ? 'today' : '',
              isSelected ? 'selected' : '',
              isDeadlineCol ? 'deadline-col' : '',
              hasNote ? 'has-note' : ''
            ].filter(Boolean).join(' ');

            html += `
              <td class="${cellClasses}"
                  data-track-id="${track.id}"
                  data-date="${iso}"
                  data-row-index="${rowIndex}"
                  data-col-index="${colIndex}"
                  data-status="${escapeHtml(value)}"
                  title="${escapeHtml(hasNote ? hasNote : '')}">
                <div class="cell-inner">
                  <span class="cell-label">${value ? escapeHtml(value) : ''}</span>
                  <button type="button"
                          class="cell-dropdown-btn"
                          data-track-id="${track.id}"
                          data-date="${iso}"
                          data-row-index="${rowIndex}"
                          data-col-index="${colIndex}">‚ñº</button>
                  <select
                    class="cell-select"
                    data-track-id="${track.id}"
                    data-date="${iso}"
                    data-row-index="${rowIndex}"
                    data-col-index="${colIndex}"
                    onchange="handleCellChange(this)"
                  >
                    ${statusOptions.map(opt => {
                      const label = opt || '---';
                      const selected = opt === value ? 'selected' : '';
                      return `<option value="${opt}" ${selected}>${label}</option>`;
                    }).join('')}
                  </select>
                </div>
              </td>
            `;
          });

          html += '</tr>';
        });
      });

      html += '</tbody></table>';
      wrapper.innerHTML = html;

      // „Çª„É´„ÅÆ„Çπ„Çø„Ç§„É´„Éª„Ç§„Éô„É≥„Éà„Å™„Å©„ÇíÂÜçÈÅ©Áî®
      styleAllCellSelects();
      attachCellEvents();
      attachRowEvents();
      attachProjectGroupEvents();
      updateSelectionStyles();
      applyStatusFilter(); // Â∑•Á®ã„Éï„Ç£„É´„ÇøÂèçÊò†
    }


    function applyGridSettings() {
      if (!state.settings) {
        state.settings = {
          cellWidth: 70,
          cellHeight: 28
        };
      }
      const { cellWidth, cellHeight } = state.settings;
      const root = document.documentElement;
      root.style.setProperty('--cell-width', (cellWidth || 70) + 'px');
      root.style.setProperty('--cell-height', (cellHeight || 28) + 'px');

      let fs = 0.68;
      if (cellWidth < 60 || cellHeight < 26) fs = 0.62;
      if (cellWidth < 40 || cellHeight < 22) fs = 0.56;
      if (cellWidth < 30 || cellHeight < 18) fs = 0.5;
      if (cellWidth < 24 || cellHeight < 16) fs = 0.46;
      root.style.setProperty('--cell-font-size', fs + 'rem');

      const colInput = document.getElementById('colWidthInput');
      const rowInput = document.getElementById('rowHeightInput');
      if (colInput) colInput.value = cellWidth || 70;
      if (rowInput) rowInput.value = cellHeight || 28;
    }

    function renderBackupStatus() {
      const el = document.getElementById('backupStatus');
      const text = document.getElementById('backupStatusText');

      if (!state.lastBackupAt) {
        text.textContent = '„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì';
        el.classList.remove('overdue');
        return;
      }

      const d = new Date(state.lastBackupAt);
      if (isNaN(d.getTime())) {
        text.textContent = '‰∏çÊòéÔºàÂÜç„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊé®Â•®Ôºâ';
        el.classList.add('overdue');
        return;
      }

      text.textContent = formatDateTimeForLabel(d);

      const now = new Date();
      const diffMs = now.getTime() - d.getTime();
      const twoDaysMs = 2 * 24 * 60 * 60 * 1000;
      if (diffMs > twoDaysMs) {
        el.classList.add('overdue');
      } else {
        el.classList.remove('overdue');
      }
    }

    function renderStatusFilterOptions() {
      const select = document.getElementById('statusFilterSelect');
      if (!select) return;
      const statuses = state.statuses || [];
      let html = `<option value="ALL">„Åô„Åπ„Å¶</option>`;
      statuses.forEach(st => {
        const name = escapeHtml(st.name);
        html += `<option value="${name}">${name}</option>`;
      });
      select.innerHTML = html;

      if (currentStatusFilter !== 'ALL') {
        const exists = statuses.some(s => s.name === currentStatusFilter);
        select.value = exists ? currentStatusFilter : 'ALL';
        if (!exists) currentStatusFilter = 'ALL';
      } else {
        select.value = 'ALL';
      }
    }

    function renderAll() {
      if (!selectedProjectId && state.projects.length) {
        selectedProjectId = state.projects[0].id;
      }
      applyGridSettings();
      renderProjects();
      renderDateRangeLabel();
      renderGrid();
      renderBackupStatus();
      renderStatusFilterOptions();
      updateFilterButtons();
      updateClientViewUI();
      updateHeatmapToggleUI();
    }

    function createAltGhost(text, clientX, clientY) {
      removeAltGhost();
      if (!text) return;
      const el = document.createElement('div');
      el.className = 'alt-ghost';
      el.textContent = text;
      el.style.left = clientX + 'px';
      el.style.top = clientY + 'px';
      document.body.appendChild(el);
      altDragGhostEl = el;
    }

    function updateAltGhostPosition(clientX, clientY) {
      if (!altDragGhostEl) return;
      altDragGhostEl.style.left = clientX + 'px';
      altDragGhostEl.style.top = clientY + 'px';
    }

    function removeAltGhost() {
      if (altDragGhostEl) {
        altDragGhostEl.remove();
        altDragGhostEl = null;
      }
    }

    function attachCellEvents() {
      const cells = document.querySelectorAll('.cell');
      cells.forEach(cell => {
        cell.addEventListener('mousedown', handleCellMouseDown);
        cell.addEventListener('mouseenter', handleCellMouseEnter);
        cell.addEventListener('mouseup', handleCellMouseUp);
        cell.addEventListener('dblclick', (ev) => {
          ev.stopPropagation();
          const trackId = cell.dataset.trackId;
          const dateIso = cell.dataset.date;
          openCellNoteEditor(trackId, dateIso);
        });
      });

      document.querySelectorAll('.cell-select').forEach(sel => {
        sel.addEventListener('focus', () => {
          const rowIndex = parseInt(sel.dataset.rowIndex, 10);
          const colIndex = parseInt(sel.dataset.colIndex, 10);
          const trackId = sel.dataset.trackId;
          const date = sel.dataset.date;
          lastFocusedCell = { rowIndex, colIndex, trackId, date };
        });
      });
    }

    function attachRowEvents() {
      // „Éà„É©„ÉÉ„ÇØ„É°„É¢„Éú„Çø„É≥
      document.querySelectorAll('.row-header-memo-btn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const projectId = btn.dataset.projectId;
          const trackId = btn.dataset.trackId;
          openTrackMemoEditor(projectId, trackId);
        });
      });

      // Êõ≤ÂâäÈô§
      document.querySelectorAll('.row-delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const trackId = btn.dataset.trackId;
          const rowData = currentRows.find(r => r.track.id === trackId);
          if (!rowData) return;

          const { project, track } = rowData;
          const ok = window.confirm(
            `Êõ≤„Äå${track.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆÊõ≤„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇÇ„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„ÅôÔºâ`
          );
          if (!ok) return;

          pushUndo();

          const proj = state.projects.find(p => p.id === project.id);
          if (proj) {
            proj.tracks = (proj.tracks || []).filter(t => t.id !== trackId);
          }
          if (state.schedule[trackId]) {
            delete state.schedule[trackId];
          }

          saveState();
          selectedCells.clear();
          lastFocusedCell = null;
          clipboardData = null;
          renderAll();
        });
      });

      // üî¥ Ê°à‰ª∂„ÅÆÁ∑†ÂàáË®≠ÂÆö„Éú„Çø„É≥
      document.querySelectorAll('.project-deadline-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const projectId = btn.dataset.projectId;
          const project = state.projects.find(p => p.id === projectId);
          if (!project) return;

          const current = project.deadline || '';
          const input = window.prompt(
            '„Åì„ÅÆÊ°à‰ª∂„ÅÆÁ∑†ÂàáÊó•„Çí YYYY-MM-DD ÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ©∫„ÅßËß£Èô§Ôºâ',
            current
          );
          if (input === null) return; // „Ç≠„É£„É≥„Çª„É´

          const trimmed = input.trim();
          pushUndo();

          if (!trimmed) {
            delete project.deadline;
          } else {
            const m = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!m) {
              window.alert('Êó•‰ªò„ÅØ YYYY-MM-DD „ÅÆÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æã: 2025-12-31');
              return;
            }
            project.deadline = trimmed;
          }

          saveState();
          renderAll();
        });
      });

      // Êõ≤„ÅÆ‰∏¶„Å≥Êõø„ÅàÔºàÊ°à‰ª∂ÂÜÖ„Åß‰∏ä‰∏ãÔºâ
      document.querySelectorAll('.row-move-up-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const projectId = btn.dataset.projectId;
          const trackId = btn.dataset.trackId;
          moveTrack(projectId, trackId, -1);
        });
      });

      document.querySelectorAll('.row-move-down-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const projectId = btn.dataset.projectId;
          const trackId = btn.dataset.trackId;
          moveTrack(projectId, trackId, 1);
        });
      });
    }

    function attachProjectGroupEvents() {
      document.querySelectorAll('.project-group-row').forEach(row => {
        row.addEventListener('click', (e) => {
          // Ê°à‰ª∂„ÅÆÁ∑†Âàá„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Å®„Åç„ÅØ„Éà„Ç∞„É´„Åó„Å™„ÅÑ
          if (e.target.closest('.project-deadline-btn')) return;

          const projectId = row.dataset.projectId;
          if (!projectId) return;

          const project = state.projects.find(p => p.id === projectId);
          if (!project) return;

          pushUndo();
          project.collapsed = !project.collapsed;
          saveState();
          renderGrid(); // „Ç∞„É™„ÉÉ„Éâ„ÅÆ„ÅøÂÜçÊèèÁîª
        });
      });
    }

    function moveTrack(projectId, trackId, delta) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project || !project.tracks) return;
      const idx = project.tracks.findIndex(t => t.id === trackId);
      if (idx < 0) return;
      const newIdx = idx + delta;
      if (newIdx < 0 || newIdx >= project.tracks.length) return;

      pushUndo();

      const [t] = project.tracks.splice(idx, 1);
      project.tracks.splice(newIdx, 0, t);
      saveState();
      renderAll();
    }

    function handleCellMouseDown(ev) {
      if (ev.button !== 0) return; // Â∑¶„ÇØ„É™„ÉÉ„ÇØ„ÅÆ„Åø
      if (ev.target.closest('.cell-dropdown-btn')) return; // ‚ñº„Éú„Çø„É≥„ÅØÈÅ∏Êäû„Å´„ÅØ‰Ωø„Çè„Å™„ÅÑ

      const cell = ev.currentTarget;
      const trackId = cell.dataset.trackId;
      const date = cell.dataset.date;
      const rowIndex = parseInt(cell.dataset.rowIndex, 10);
      const colIndex = parseInt(cell.dataset.colIndex, 10);
      const key = cellKey(trackId, date);

      hideContextMenu();

      if (ev.altKey) {
        const trackSchedule = state.schedule[trackId] || {};
        const value = trackSchedule[date] || '';
        altDragSource = { trackId, date, value };
        isAltDragging = true;
        if (value) {
          createAltGhost(value, ev.clientX, ev.clientY);
        }
        return;
      }

      isSelecting = true;
      selectionAnchorCoords = { rowIndex, colIndex };

      const multi = ev.ctrlKey || ev.metaKey;

      if (multi) {
        if (selectedCells.has(key)) {
          selectedCells.delete(key);
        } else {
          selectedCells.add(key);
        }
      } else if (ev.shiftKey && lastFocusedCell) {
        const anchor = {
          rowIndex: lastFocusedCell.rowIndex,
          colIndex: lastFocusedCell.colIndex
        };
        const target = { rowIndex, colIndex };
        setSelectionRectangle(anchor, target);
      } else {
        selectedCells.clear();
        selectedCells.add(key);
      }

      lastFocusedCell = { rowIndex, colIndex, trackId, date };
      updateSelectionStyles();
    }

    function handleCellMouseEnter(ev) {
      if (!isSelecting || !selectionAnchorCoords) return;
      const cell = ev.currentTarget;
      const rowIndex = parseInt(cell.dataset.rowIndex, 10);
      const colIndex = parseInt(cell.dataset.colIndex, 10);
      const target = { rowIndex, colIndex };
      setSelectionRectangle(selectionAnchorCoords, target);
    }

    function handleCellMouseUp(ev) {
      const cell = ev.currentTarget;
      const trackId = cell.dataset.trackId;
      const date = cell.dataset.date;
      const rowIndex = parseInt(cell.dataset.rowIndex, 10);
      const colIndex = parseInt(cell.dataset.colIndex, 10);

      if (isAltDragging && altDragSource) {
        pushUndo();
        const src = altDragSource;
        if (!state.schedule[trackId]) {
          state.schedule[trackId] = {};
        }
        if (src.value) {
          state.schedule[trackId][date] = src.value;
        } else {
          delete state.schedule[trackId][date];
        }
        saveState();
        renderGrid();
      }

      isSelecting = false;
      isAltDragging = false;
      altDragSource = null;
      removeAltGhost();

      lastFocusedCell = { rowIndex, colIndex, trackId, date };
    }

    window.addEventListener('mouseup', () => {
      isSelecting = false;
      isAltDragging = false;
      altDragSource = null;
      removeAltGhost();
    });

    window.addEventListener('mousemove', (ev) => {
      if (isAltDragging) {
        updateAltGhostPosition(ev.clientX, ev.clientY);
      }
    });

    window.handleCellChange = function(selectEl) {
      const trackId = selectEl.dataset.trackId;
      const date = selectEl.dataset.date;
      const value = selectEl.value;
      const key = cellKey(trackId, date);

      function applyTo(trackId, date, value) {
        if (!state.schedule[trackId]) {
          state.schedule[trackId] = {};
        }
        if (value) {
          state.schedule[trackId][date] = value;
        } else {
          delete state.schedule[trackId][date];
        }
      }

      pushUndo();

      if (selectedCells.size > 1 && selectedCells.has(key)) {
        selectedCells.forEach(k => {
          const [t, d] = k.split('|');
          applyTo(t, d, value);
        });
      } else {
        applyTo(trackId, date, value);
      }

      saveState();
      renderGrid();
    };

    function updateFilterButtons() {
      const allBtn = document.getElementById('showAllBtn');
      const selBtn = document.getElementById('showSelectedBtn');
      if (showOnlySelected) {
        selBtn.classList.add('active');
        allBtn.classList.remove('active');
      } else {
        allBtn.classList.add('active');
        selBtn.classList.remove('active');
      }
    }

    function openStatusEditor() {
      const overlay = document.getElementById('statusEditorOverlay');
      overlay.classList.remove('hidden');
      renderStatusEditor();
    }

    function closeStatusEditor() {
      const overlay = document.getElementById('statusEditorOverlay');
      overlay.classList.add('hidden');
    }

    

    function renderStatusEditor() {
      const container = document.getElementById('statusListContainer');
      container.innerHTML = '';

      if (!state.statuses || !Array.isArray(state.statuses) || state.statuses.length === 0) {
        state.statuses = DEFAULT_STATUSES;
      }

      state.statuses.forEach(st => {
        const row = document.createElement('div');
        row.className = 'status-row';
        row.innerHTML = `
          <input type="text" class="status-name-input" value="${escapeHtml(st.name)}" placeholder="Â∑•Á®ãÂêçÔºà‰æãÔºö‰ΩúÊõ≤Ôºâ">
          <input type="color" class="status-color-input" value="${st.color || '#f5576c'}">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">‚úï</button>
        `;
        const deleteBtn = row.querySelector('.status-delete-btn');
        deleteBtn.addEventListener('click', () => {
          row.remove();
        });
        container.appendChild(row);
      });
    }

    function collectStatusesFromEditor() {
      const container = document.getElementById('statusListContainer');
      const rows = Array.from(container.querySelectorAll('.status-row'));
      const list = [];

      rows.forEach(row => {
        const nameInput = row.querySelector('.status-name-input');
        const colorInput = row.querySelector('.status-color-input');
        const name = nameInput.value.trim();
        const color = colorInput.value || '#f5576c';
        if (!name) return;
        list.push({ name, color });
      });

      if (list.length === 0) {
        return DEFAULT_STATUSES;
      }
      return list;
    }

    function showContextMenu(x, y) {
      const menu = document.getElementById('contextMenu');
      menu.classList.remove('hidden');

      const rect = menu.getBoundingClientRect();
      let px = x;
      let py = y;
      if (px + rect.width > window.innerWidth) {
        px = window.innerWidth - rect.width - 4;
      }
      if (py + rect.height > window.innerHeight) {
        py = window.innerHeight - rect.height - 4;
      }
      menu.style.left = px + 'px';
      menu.style.top = py + 'px';
    }

    function hideContextMenu() {
      const menu = document.getElementById('contextMenu');
      menu.classList.add('hidden');
      contextMenuTarget = null;
    }

    function handleContextMenuEvent(ev) {
      const cell = ev.target.closest('.cell');
      if (!cell) {
        hideContextMenu();
        return;
      }
      ev.preventDefault();

      const trackId = cell.dataset.trackId;
      const date = cell.dataset.date;
      const rowIndex = parseInt(cell.dataset.rowIndex, 10);
      const colIndex = parseInt(cell.dataset.colIndex, 10);

      lastFocusedCell = { rowIndex, colIndex, trackId, date };
      contextMenuTarget = { rowIndex, colIndex, trackId, date };

      updateSelectionStyles();
      showContextMenu(ev.clientX, ev.clientY);
    }

    function copySelectionToClipboard() {
      let coords = getSelectedCellCoords();

      if (!coords.length && lastFocusedCell && currentRows.length && currentDates.length) {
        const { rowIndex, colIndex, trackId, date } = lastFocusedCell;
        coords = [{ rowIndex, colIndex, trackId, date }];
      }

      if (!coords.length) return;

      const rows = coords.map(c => c.rowIndex);
      const cols = coords.map(c => c.colIndex);
      const minRow = Math.min(...rows);
      const maxRow = Math.max(...rows);
      const minCol = Math.min(...cols);
      const maxCol = Math.max(...cols);

      const height = maxRow - minRow + 1;
      const width = maxCol - minCol + 1;
      const data = Array.from({ length: height }, () => Array.from({ length: width }, () => ''));

      coords.forEach(c => {
        const r = c.rowIndex - minRow;
        const col = c.colIndex - minCol;
        const trackId = c.trackId;
        const date = c.date;
        const value = (state.schedule[trackId] || {})[date] || '';
        data[r][col] = value;
      });

      clipboardData = { data, width, height };
    }

    function pasteClipboardAtAnchor(anchorOverride) {
      if (!clipboardData) return;

      let anchor = anchorOverride || lastFocusedCell;
      if (!anchor) {
        const coords = getSelectedCellCoords();
        if (!coords.length) return;
        const rows = coords.map(c => c.rowIndex);
        const cols = coords.map(c => c.colIndex);
        anchor = {
          rowIndex: Math.min(...rows),
          colIndex: Math.min(...cols)
        };
      }

      const { data, width, height } = clipboardData;

      pushUndo();

      for (let r = 0; r < height; r++) {
        const targetRow = anchor.rowIndex + r;
        if (!currentRows[targetRow]) continue;
        const trackId = currentRows[targetRow].track.id;

        for (let c = 0; c < width; c++) {
          const targetCol = anchor.colIndex + c;
          if (!currentDates[targetCol]) continue;
          const dateIso = formatDateISO(currentDates[targetCol]);
          const value = data[r][c];
          if (!state.schedule[trackId]) {
            state.schedule[trackId] = {};
          }
          if (value) {
            state.schedule[trackId][dateIso] = value;
          } else {
            delete state.schedule[trackId][dateIso];
          }
        }
      }

      saveState();
      renderGrid();
    }

    function clearSelectedCells() {
      let coords = getSelectedCellCoords();

      if (!coords.length && lastFocusedCell && currentRows.length && currentDates.length) {
        const { rowIndex, colIndex, trackId, date } = lastFocusedCell;
        coords = [{ rowIndex, colIndex, trackId, date }];
      }

      if (!coords.length) return;

      pushUndo();

      coords.forEach(c => {
        if (state.schedule[c.trackId]) {
          delete state.schedule[c.trackId][c.date];
        }
      });

      saveState();
      renderGrid();
    }

    function doExportBackup() {
      const now = new Date();
      state.lastBackupAt = now.toISOString();
      saveState();
      renderBackupStatus();

      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });

      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const mi = String(now.getMinutes()).padStart(2, '0');
      const filename = `schedule_backup_${yyyy}${mm}${dd}_${hh}${mi}.json`;

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // --- ÂÖ•Âäõ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÈñ¢ÈÄ£ ---

    function openInputPopover(type, anchorBtn) {
      const pop = document.getElementById('inputPopover');
      const titleEl = document.getElementById('inputPopoverTitle');
      const field = document.getElementById('inputPopoverField');
      const okBtn = document.getElementById('inputPopoverOkBtn');

      inputPopoverState.type = type;
      inputPopoverState.anchorBtn = anchorBtn;

      if (type === 'project') {
        titleEl.textContent = 'Êñ∞„Åó„ÅÑÊ°à‰ª∂Âêç';
        okBtn.textContent = 'ËøΩÂä†';
      } else if (type === 'track') {
        titleEl.textContent = 'Êñ∞„Åó„ÅÑÊõ≤Âêç';
        okBtn.textContent = 'ËøΩÂä†';
      }

      field.value = '';
      pop.classList.remove('hidden');

      const rect = anchorBtn.getBoundingClientRect();
      pop.style.left = rect.left + 'px';
      pop.style.top = (rect.bottom + 6) + 'px';

      const popRect = pop.getBoundingClientRect();
      let left = rect.left;
      let top = rect.bottom + 6;

      if (left + popRect.width > window.innerWidth - 8) {
        left = window.innerWidth - popRect.width - 8;
      }
      if (top + popRect.height > window.innerHeight - 8) {
        top = rect.top - popRect.height - 6;
      }

      pop.style.left = left + 'px';
      pop.style.top = top + 'px';

      field.focus();
      field.select();
    }

    function closeInputPopover() {
      const pop = document.getElementById('inputPopover');
      pop.classList.add('hidden');
      inputPopoverState.type = null;
      inputPopoverState.anchorBtn = null;
    }

    function handleInputPopoverOk() {
      const field = document.getElementById('inputPopoverField');
      const value = field.value.trim();
      if (!value) {
        closeInputPopover();
        return;
      }

      if (inputPopoverState.type === 'project') {
        addProject(value);
      } else if (inputPopoverState.type === 'track') {
        addTrackToSelectedProject(value);
      }

      closeInputPopover();
    }

    function addProject(name) {
      pushUndo();

      const project = {
        id: generateId(),
        name: name.trim(),
        color: '#f2c56b',
        tracks: []
      };
      state.projects.push(project);
      selectedProjectId = project.id;
      saveState();
      renderAll();
    }

    function addTrackToSelectedProject(name) {
      if (!selectedProjectId) {
        window.alert('„Åæ„ÅöÂ∑¶„ÅÆÊ°à‰ª∂„É™„Çπ„Éà„Åã„Çâ„ÄÅÊõ≤„ÇíËøΩÂä†„Åó„Åü„ÅÑÊ°à‰ª∂„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }
      const project = state.projects.find(p => p.id === selectedProjectId);
      if (!project) {
        window.alert('ÈÅ∏Êäû‰∏≠„ÅÆÊ°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
        return;
      }

      pushUndo();

      const track = { id: generateId(), name: name.trim() };
      project.tracks.push(track);
      saveState();
      renderAll();
    }

    function getEarliestDateForTrack(trackId) {
      const sched = state.schedule[trackId];
      if (!sched) return null;
      let min = null;
      Object.keys(sched).forEach(dateStr => {
        const dt = parseISO(dateStr);
        if (isNaN(dt.getTime())) return;
        if (!min || dt < min) min = dt;
      });
      return min;
    }

    function autoStairSort() {
      pushUndo();

      state.projects.forEach(project => {
        if (!project.tracks || project.tracks.length <= 1) return;
        project.tracks.sort((a, b) => {
          const da = getEarliestDateForTrack(a.id);
          const db = getEarliestDateForTrack(b.id);
          if (da && db) {
            const diff = da - db;
            if (diff !== 0) return diff;
            return a.name.localeCompare(b.name, 'ja');
          } else if (da && !db) {
            return -1;
          } else if (!da && db) {
            return 1;
          } else {
            return a.name.localeCompare(b.name, 'ja');
          }
        });
      });
      saveState();
      renderAll();
    }

    function setClientViewMode(on) {
      clientViewMode = on;
      document.body.classList.toggle('client-view-mode', on);
      updateClientViewUI();
    }

    function updateClientViewUI() {
      const btn = document.getElementById('clientViewToggleBtn');
      if (btn) {
        if (clientViewMode) {
          btn.classList.add('active');
          btn.textContent = 'üëÅ ÈÄöÂ∏∏„Éì„É•„Éº„Å´Êàª„Çã';
        } else {
          btn.classList.remove('active');
          btn.textContent = 'üëÅ „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„Éº';
        }
      }

      const banner = document.getElementById('clientViewBanner');
      if (banner) {
        banner.classList.toggle('hidden', !clientViewMode);
      }
    }


    function applyStatusFilter() {
      const cells = document.querySelectorAll('.cell');
      cells.forEach(cell => {
        cell.classList.remove('dim');
        if (currentStatusFilter && currentStatusFilter !== 'ALL') {
          const statusName = cell.dataset.status || '';
          if (!statusName || statusName !== currentStatusFilter) {
            cell.classList.add('dim');
          }
        }
      });
    }

    function setupEvents() {
      const addProjectBtn = document.getElementById('addProjectBtn');
      const addTrackBtn = document.getElementById('addTrackBtn');

      addProjectBtn.addEventListener('click', () => {
        openInputPopover('project', addProjectBtn);
      });

      addTrackBtn.addEventListener('click', () => {
        openInputPopover('track', addTrackBtn);
      });

      document.getElementById('autoStairSortBtn').addEventListener('click', () => {
        autoStairSort();
      });

      document.getElementById('showAllBtn').addEventListener('click', () => {
        showOnlySelected = false;
        updateFilterButtons();
        renderAll();
      });

      document.getElementById('showSelectedBtn').addEventListener('click', () => {
        showOnlySelected = true;
        updateFilterButtons();
        renderAll();
      });

      document.getElementById('prevRangeBtn').addEventListener('click', () => {
        const days = state.daysToShow || DEFAULT_DAYS_TO_SHOW;
        const start = parseISO(state.startDate);
        const newStart = addDays(start, -days);
        pushUndo();
        state.startDate = formatDateISO(newStart);
        saveState();
        renderAll();
      });

      document.getElementById('nextRangeBtn').addEventListener('click', () => {
        const days = state.daysToShow || DEFAULT_DAYS_TO_SHOW;
        const start = parseISO(state.startDate);
        const newStart = addDays(start, days);
        pushUndo();
        state.startDate = formatDateISO(newStart);
        saveState();
        renderAll();
      });

      const themeToggleBtn = document.getElementById('themeToggleBtn');
      if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
          const nextTheme = (state.settings && state.settings.theme === 'light') ? 'dark' : 'light';
          setTheme(nextTheme);
        });
      }

      const tagToggleBtn = document.getElementById('tagToggleBtn');
      if (tagToggleBtn) {
        tagToggleBtn.addEventListener('click', () => {
          const current = !(state.settings && state.settings.showProjectTags === false);
          setTagVisibility(!current);
        });
      }

    

      document.getElementById('exportBtn').addEventListener('click', () => {
        doExportBackup();
      });

      document.getElementById('importInput').addEventListener('change', (ev) => {
        const file = ev.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
          try {
            const raw = e.target.result;
            const parsed = JSON.parse(raw);

            // ‚òÖ Ë™≠„ÅøËæº„Çì„Å†Áä∂ÊÖã„ÇíÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥‰ªïÊßò„Å´Âêà„Çè„Åõ„Å¶Ë£úÊ≠£
            const data = normalizeImportedState(parsed);

            // „Åì„Åì„Åæ„ÅßÊù•„Åü„ÇâÊ≠£Â∏∏„Å®„Åø„Å™„Åó„Å¶ state „Å´ÂèçÊò†
            state = data;
            undoStack = []; // Âà•„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÊôÇ„ÅØ Undo „É™„Çª„ÉÉ„Éà
            selectedCells.clear();
            lastFocusedCell = null;
            clipboardData = null;

            saveState();
            applyTheme(state.settings.theme);
            applyTagVisibility(state.settings.showProjectTags);
            renderAll();
            window.alert('JSON„Åã„ÇâÁä∂ÊÖã„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ');
          } catch (err) {
            console.error(err);
            window.alert('JSON„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô„ÄÇ');
          } finally {
            // Âêå„Åò„Éï„Ç°„Ç§„É´„ÇíÁ∂ö„Åë„Å¶Ë™≠„ÅøËæº„ÇÅ„Çã„Çà„ÅÜ„Å´„É™„Çª„ÉÉ„Éà
            ev.target.value = '';
          }
        };
        reader.readAsText(file, 'utf-8');
      });


      // ‚ñº„Éú„Çø„É≥ ‚Üí „Éç„Ç§„ÉÜ„Ç£„Éñ„ÅÆ„Çª„É¨„ÇØ„Éà„ÇíÈñã„Åè
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.cell-dropdown-btn');
        if (!btn) return;

        const cell = btn.closest('.cell');
        if (!cell) return;
        const select = cell.querySelector('.cell-select');
        if (!select) return;

        if (typeof select.showPicker === 'function') {
          select.showPicker();
        } else {
          select.focus();
          const evt = new MouseEvent('mousedown', {
            bubbles: true,
            cancelable: true,
            view: window
          });
          select.dispatchEvent(evt);
          select.click();
        }
      });

      // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÔºàÂè≥„ÇØ„É™„ÉÉ„ÇØÔºâ
      document.addEventListener('contextmenu', handleContextMenuEvent);
      document.addEventListener('mousedown', (ev) => {
        const menu = document.getElementById('contextMenu');
        if (!menu.classList.contains('hidden')) {
          if (!ev.target.closest('#contextMenu')) {
            hideContextMenu();
          }
        }

        const pop = document.getElementById('inputPopover');
        if (!pop.classList.contains('hidden')) {
          if (!ev.target.closest('#inputPopover') &&
              !ev.target.closest('#addProjectBtn') &&
              !ev.target.closest('#addTrackBtn')) {
            closeInputPopover();
          }
        }
      });
      window.addEventListener('scroll', () => {
        hideContextMenu();
      }, true);

      document.querySelectorAll('#contextMenu .context-menu-item').forEach(item => {
        item.addEventListener('click', () => {
          const action = item.dataset.action;
          if (action === 'copy') {
            copySelectionToClipboard();
          } else if (action === 'paste') {
            pasteClipboardAtAnchor(contextMenuTarget || lastFocusedCell || null);
          } else if (action === 'clear') {
            clearSelectedCells();
          }
          hideContextMenu();
        });
      });

      // Â∑•Á®ã„Éï„Ç£„É´„Çø
      const filterSelect = document.getElementById('statusFilterSelect');
      filterSelect.addEventListener('change', () => {
        currentStatusFilter = filterSelect.value;
        applyStatusFilter();
      });

      // Undo„Éú„Çø„É≥
      document.getElementById('undoBtn').addEventListener('click', () => {
        undoLast();
      });

      // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É•„Éº
      document.getElementById('clientViewToggleBtn').addEventListener('click', () => {
        setClientViewMode(!clientViewMode);
      });

      const clientViewBackBtn = document.getElementById('clientViewBackBtn');
      if (clientViewBackBtn) {
        clientViewBackBtn.addEventListener('click', () => {
          setClientViewMode(false);
        });
      }

      // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
      document.addEventListener('keydown', (ev) => {
        const meta = ev.ctrlKey || ev.metaKey;
        const target = ev.target;
        const tag = target.tagName;
        const isCellSelect = (tag === 'SELECT' && target.classList.contains('cell-select'));

        const inTextField =
          (tag === 'INPUT' || tag === 'TEXTAREA' || target.isContentEditable) &&
          !isCellSelect;

        const pop = document.getElementById('inputPopover');
        const popVisible = !pop.classList.contains('hidden');
        if (popVisible) {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            handleInputPopoverOk();
            return;
          }
          if (ev.key === 'Escape') {
            ev.preventDefault();
            closeInputPopover();
            return;
          }
        }

        if (meta && (ev.key === 's' || ev.key === 'S')) {
          ev.preventDefault();
          doExportBackup();
          return;
        }

        if (meta && (ev.key === 'c' || ev.key === 'C')) {
          ev.preventDefault();
          copySelectionToClipboard();
          return;
        }

        if (meta && (ev.key === 'v' || ev.key === 'V')) {
          ev.preventDefault();
          pasteClipboardAtAnchor();
          return;
        }

        if (meta && (ev.key === 'z' || ev.key === 'Z')) {
          if (inTextField) return;
          ev.preventDefault();
          undoLast();
          return;
        }

        if ((ev.key === 'Delete' || ev.key === 'Backspace')) {
          if (inTextField) return;
          ev.preventDefault();
          clearSelectedCells();
          return;
        }
      });

      const colInput = document.getElementById('colWidthInput');
      const rowInput = document.getElementById('rowHeightInput');

      if (colInput) {
        colInput.addEventListener('change', () => {
          let v = parseInt(colInput.value, 10);
          if (isNaN(v)) v = 70;
          v = Math.max(20, Math.min(200, v));
          pushUndo();
          state.settings.cellWidth = v;
          saveState();
          applyGridSettings();
          renderGrid();
        });
      }

      if (rowInput) {
        rowInput.addEventListener('change', () => {
          let v = parseInt(rowInput.value, 10);
          if (isNaN(v)) v = 28;
          v = Math.max(14, Math.min(80, v));
          pushUndo();
          state.settings.cellHeight = v;
          saveState();
          applyGridSettings();
          renderGrid();
        });
      }

      const daysInput = document.getElementById('daysToShowInput');
      if (daysInput) {
        daysInput.addEventListener('change', () => {
          let v = parseInt(daysInput.value, 10);
          if (isNaN(v)) v = DEFAULT_DAYS_TO_SHOW;
          v = Math.max(7, Math.min(90, v));
          pushUndo();
          state.daysToShow = v;
          saveState();
          renderAll();
        });
      }

      document.getElementById('editStatusesBtn').addEventListener('click', () => {
        openStatusEditor();
      });
      document.getElementById('closeStatusEditorBtn').addEventListener('click', () => {
        closeStatusEditor();
      });
      document.getElementById('addStatusRowBtn').addEventListener('click', () => {
        const container = document.getElementById('statusListContainer');
        const row = document.createElement('div');
        row.className = 'status-row';
        row.innerHTML = `
          <input type="text" class="status-name-input" value="" placeholder="Â∑•Á®ãÂêçÔºà‰æãÔºö„É™„Éü„ÉÉ„ÇØ„ÇπÔºâ">
          <input type="color" class="status-color-input" value="#f5576c">
          <button class="btn btn-ghost btn-sm status-delete-btn" type="button">‚úï</button>
        `;
        row.querySelector('.status-delete-btn').addEventListener('click', () => {
          row.remove();
        });
        container.appendChild(row);
      });
      document.getElementById('saveStatusesBtn').addEventListener('click', () => {
        const list = collectStatusesFromEditor();
        pushUndo();
        state.statuses = list;
        saveState();
        closeStatusEditor();
        renderAll();
      });

      document.getElementById('statusEditorOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'statusEditorOverlay') {
          closeStatusEditor();
        }
      });
      document.getElementById('inputPopoverCancelBtn').addEventListener('click', () => {
        closeInputPopover();
      });
      document.getElementById('inputPopoverOkBtn').addEventListener('click', () => {
        handleInputPopoverOk();
      });

      // „Éà„É©„ÉÉ„ÇØ„É°„É¢„Éú„Çø„É≥
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.row-header-memo-btn');
        if (!btn) return;
        ev.stopPropagation();
        const projectId = btn.dataset.projectId;
        const trackId = btn.dataset.trackId;
        openTrackMemoEditor(projectId, trackId);
      });

            // „Éà„É©„ÉÉ„ÇØ„É°„É¢ / „Çª„É´„Éé„Éº„Éà „É¢„Éº„ÉÄ„É´Êìç‰ΩúÔºàdocument„Å∏„ÅÆ„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
      document.addEventListener('click', (e) => {
        const target = e.target;

        // ‚ñº „Éà„É©„ÉÉ„ÇØ„É°„É¢Ôºö‰øùÂ≠ò„Éú„Çø„É≥
        if (target.id === 'trackMemoSaveBtn') {
          e.preventDefault();
          saveTrackMemo();
          return;
        }

        // ‚ñº „Éà„É©„ÉÉ„ÇØ„É°„É¢Ôºö‚úï„Éú„Çø„É≥
        if (target.id === 'trackMemoCancelBtn') {
          e.preventDefault();
          closeTrackMemoEditor();
          return;
        }

        // ‚ñº „Éà„É©„ÉÉ„ÇØ„É°„É¢Ôºö„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        if (target.id === 'trackMemoOverlay') {
          e.preventDefault();
          closeTrackMemoEditor();
          return;
        }

        // ‚ñº „Çª„É´„Éé„Éº„ÉàÔºö‰øùÂ≠ò„Éú„Çø„É≥
        if (target.id === 'cellNoteSaveBtn') {
          e.preventDefault();
          saveCellNote();
          return;
        }

        // ‚ñº „Çª„É´„Éé„Éº„ÉàÔºö‚úï„Éú„Çø„É≥
        if (target.id === 'cellNoteCloseBtn') {
          e.preventDefault();
          closeCellNoteEditor();
          return;
        }

        // ‚ñº „Çª„É´„Éé„Éº„ÉàÔºö„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        if (target.id === 'cellNoteOverlay') {
          e.preventDefault();
          closeCellNoteEditor();
          return;
        }
      });


      // „Éí„Éº„Éà„Éû„ÉÉ„Éó„Éà„Ç∞„É´
      document.getElementById('heatmapToggleBtn')?.addEventListener('click', () => {
        if (!state.settings) state.settings = {};
        pushUndo();
        state.settings.heatmapEnabled = !state.settings.heatmapEnabled;
        saveState();
        renderAll();
      });
    }

    function updateHeatmapToggleUI() {
      const btn = document.getElementById('heatmapToggleBtn');
      if (!btn) return;
      const enabled = state.settings && state.settings.heatmapEnabled;
      if (enabled) {
        btn.classList.add('active');
        btn.textContent = 'üî• „Éí„Éº„Éà„Éû„ÉÉ„ÉóON';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'üî• „Éí„Éº„Éà„Éû„ÉÉ„ÉóOFF';
      }
    }

    function updateThemeToggleUI(forcedTheme) {
      const btn = document.getElementById('themeToggleBtn');
      if (!btn) return;
      const theme = forcedTheme || (state.settings && state.settings.theme) || 'dark';
      const isLight = theme === 'light';
      btn.textContent = isLight ? 'üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ' : '‚òÄÔ∏è „É©„Ç§„Éà„É¢„Éº„Éâ';
      btn.classList.toggle('active', isLight);
    }

    function applyTheme(theme) {
      const mode = (theme === 'light') ? 'light' : 'dark';
      document.body.classList.toggle('theme-light', mode === 'light');
      document.body.classList.toggle('theme-dark', mode === 'dark');
      document.documentElement.style.colorScheme = mode === 'light' ? 'light' : 'dark';
      updateThemeToggleUI(mode);
      if (typeof styleAllCellSelect === 'function') {
        styleAllCellSelect();
      }
    }

    function setTheme(theme) {
      ensureSettingsObject();
      const mode = (theme === 'light') ? 'light' : 'dark';
      state.settings.theme = mode;
      saveState();
      applyTheme(mode);
    }

    function applyTagVisibility(on) {
      const show = on !== false;
      document.body.classList.toggle('hide-row-tags', !show);
      updateTagToggleUI(show);
    }

    function setTagVisibility(on) {
      ensureSettingsObject();
      state.settings.showProjectTags = !!on;
      saveState();
      applyTagVisibility(on);
    }

    function updateTagToggleUI(on) {
      const btn = document.getElementById('tagToggleBtn');
      if (!btn) return;
      const show = on !== false;
      btn.textContent = show ? 'üè∑ „Çø„Ç∞ÈùûË°®Á§∫' : 'üè∑ „Çø„Ç∞Ë°®Á§∫';
      btn.classList.toggle('active', show);
    }

    function openTrackMemoEditor(projectId, trackId) {
      trackMemoState.projectId = projectId;
      trackMemoState.trackId = trackId;

      const project = state.projects.find(p => p.id === projectId);
      const track = project?.tracks.find(t => t.id === trackId);
      if (!project || !track) return;

      const modal = document.getElementById('trackMemoOverlay');
      const title = document.getElementById('trackMemoTitle');
      const textarea = document.getElementById('trackMemoText');

      title.textContent = `${escapeHtml(project.name)} - ${escapeHtml(track.name)}`;
      textarea.value = track.memo || '';
      modal.classList.remove('hidden');
      textarea.focus();
    }

    function closeTrackMemoEditor() {
      const modal = document.getElementById('trackMemoOverlay');
      if (modal) modal.classList.add('hidden');
      trackMemoState.projectId = null;
      trackMemoState.trackId = null;
    }

    function saveTrackMemo() {
      if (!trackMemoState.projectId || !trackMemoState.trackId) return;

      const project = state.projects.find(p => p.id === trackMemoState.projectId);
      const track = project?.tracks.find(t => t.id === trackMemoState.trackId);
      if (!project || !track) {
        closeTrackMemoEditor();
        return;
      }

      const textarea = document.getElementById('trackMemoText');
      const newMemo = textarea.value.trim();

      pushUndo();
      track.memo = newMemo;
      saveState();
      closeTrackMemoEditor();
      renderGrid();
    }

    function openCellNoteEditor(trackId, dateIso) {
      cellNoteState.trackId = trackId;
      cellNoteState.dateIso = dateIso;

      const modal = document.getElementById('cellNoteOverlay');
      const title = document.getElementById('cellNoteTitle');
      const textarea = document.getElementById('cellNoteTextarea');

      const cellNoteKey = cellKey(trackId, dateIso);
      const currentNote = state.cellNotes[cellNoteKey] || '';

      title.textContent = `${dateIso} „ÅÆ„É°„É¢`;
      textarea.value = currentNote;
      modal.classList.remove('hidden');
      textarea.focus();
    }

    function closeCellNoteEditor() {
      const modal = document.getElementById('cellNoteOverlay');
      if (modal) modal.classList.add('hidden');
      cellNoteState.trackId = null;
      cellNoteState.dateIso = null;
    }

    function saveCellNote() {
      if (!cellNoteState.trackId || !cellNoteState.dateIso) return;

      const textarea = document.getElementById('cellNoteTextarea');
      const newNote = textarea.value.trim();
      const cellNoteKey = cellKey(cellNoteState.trackId, cellNoteState.dateIso);

      pushUndo();
      if (newNote) {
        state.cellNotes[cellNoteKey] = newNote;
      } else {
        delete state.cellNotes[cellNoteKey];
      }
      saveState();
      closeCellNoteEditor();
      renderGrid();
    }
    // --- Êó•Ê¨°„É≠„Éº„É´ÔºàÊØéÊó• 4:00 „Å´„Äå‰ªäÊó•„Äç„Çπ„Çø„Éº„ÉàÔºÜÈÅéÂéª„Çª„É´ÂâäÈô§ÔºâÈñ¢ÈÄ£ ---

    function ensureSettingsObject() {
      if (!state.settings) state.settings = {};
    }



        // „ÄåÊØéÊó•4:00„ÇíÈÅé„Åé„Å¶„ÅÑ„Åü„Çâ„ÄçstartDate„Çí‰ªäÊó•„Å´„Åù„Çç„Åà„ÇãÔºàÈÅéÂéª„Çª„É´„ÅØÊ∂à„Åï„Å™„ÅÑÔºâ
    function autoDailyRollIfNeeded() {
      ensureSettingsObject();

      const now = new Date();
      const todayIso = formatDateISO(toDateOnly(now));

      const lastRoll = state.settings.lastRollDate || null;

      // „Äå4:00 „ÇíÈÅé„Åé„Å¶„ÅÑ„Çã„ÅãÔºü„Äç
      const hasPassedRollTime =
        now.getHours() > 4 || (now.getHours() === 4 && now.getMinutes() >= 0);

      // „Åæ„Å†‰ªäÊó•ÂàÜ„ÅÆ„É≠„Éº„É´„Çí„Åó„Å¶„ÅÑ„Å™„Åè„Å¶„ÄÅ4:00 „ÇíÈÅé„Åé„Å¶„ÅÑ„Åü„ÇâÂÆüË°å
      if (hasPassedRollTime && lastRoll !== todayIso) {
        pushUndo();

        // ‚òÖÈÅéÂéª„Çª„É´„ÅØÊÆã„Åó„Åü„Åæ„Åæ„ÄÅË°®Á§∫ÈñãÂßãÊó•„Å†„Åë‰ªäÊó•„Å´Âêà„Çè„Åõ„Çã
        state.startDate = todayIso;

        // ‰ªäÊó•ÂàÜ„ÅØ„É≠„Éº„É´Ê∏à„Åø„Å®„Åó„Å¶Ë®òÈå≤
        state.settings.lastRollDate = todayIso;

        saveState();
      }
    }


    // ÂàùÂõûÂÆüË°å + ‰ª•Âæå1ÂàÜ„Åä„Åç„ÉÅ„Çß„ÉÉ„ÇØ
    function startAutoRollTimer() {
      // Ëµ∑ÂãïÊôÇ„Å´‰∏ÄÂ∫¶„ÉÅ„Çß„ÉÉ„ÇØ
      autoDailyRollIfNeeded();
      // „Åù„ÅÆÂæå„ÅØ1ÂàÜ„Åî„Å®„Å´„Äå4:00 „ÇíÈÅé„Åé„Å¶Êó•‰ªò„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„Äç„ÇíÁ¢∫Ë™ç
      setInterval(autoDailyRollIfNeeded, 60 * 1000);
    }


function applyGridSettingsOnce() {
      applyGridSettings();
    }

    setupEvents();
    applyGridSettingsOnce();

    // ‚òÖ„Åì„Åì„ÅßÊó•Ê¨°„É≠„Éº„É´„ÅÆ„Çø„Ç§„Éû„Éº„Çí„Çπ„Çø„Éº„Éà
    startAutoRollTimer();

    // „É≠„Éº„É´Âæå„ÅÆÁä∂ÊÖã„ÅßÊèèÁîª
    renderAll();
  </script>

  <!-- „Éà„É©„ÉÉ„ÇØ„É°„É¢Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay hidden" id="trackMemoOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="trackMemoTitle">„Éà„É©„ÉÉ„ÇØ„É°„É¢</div>
        <button class="btn btn-ghost btn-sm" id="trackMemoCancelBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <textarea id="trackMemoText"
                  style="width:100%; min-height:120px; resize:vertical;
                         border-radius:8px; border:1px solid rgba(255,255,255,0.16);
                         background:rgba(0,0,0,0.45); color:var(--text-main);
                         font-size:0.8rem; padding:6px 8px; outline:none;"></textarea>
      </div>
      <div class="modal-footer">
        <span class="modal-note">‚ÄªÊ°à‰ª∂ √ó Êõ≤„Å´Á¥ê„Å•„Åè„É°„É¢„Åß„ÅôÔºàÂ∑•Á®ã„Å®„ÅØÂà•ÁÆ°ÁêÜÔºâ„ÄÇ</span>
        <button class="btn btn-primary btn-sm" id="trackMemoSaveBtn">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- „Çª„É´„É°„É¢Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay hidden" id="cellNoteOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="cellNoteTitle">„Çª„É´„É°„É¢</div>
        <button class="btn btn-ghost btn-sm" id="cellNoteCloseBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <textarea id="cellNoteTextarea"
                  style="width:100%; min-height:100px; resize:vertical;
                         border-radius:8px; border:1px solid rgba(255,255,255,0.16);
                         background:rgba(0,0,0,0.45); color:var(--text-main);
                         font-size:0.8rem; padding:6px 8px; outline:none;"></textarea>
      </div>
      <div class="modal-footer">
        <span class="modal-note">‚Äª„Åì„ÅÆ„Çª„É´„Å†„Åë„Å´Á¥ê„Å•„Åè„É°„É¢„Åß„ÅôÔºàÂ∑•Á®ã„Å®„ÅØÂà•Ôºâ„ÄÇ</span>
        <button class="btn btn-primary btn-sm" id="cellNoteSaveBtn">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <div id="cellTooltip" class="cell-tooltip hidden"></div>

</body>
</html>
